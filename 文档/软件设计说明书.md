好的，收到。这是为您整合了所有最新功能（包括**个人中心、收藏夹、搜索与分类、管理员特权及全权管理**）的**《软件设计说明书》最终完整版**。

这份文档已经包含了所有数据库变更（新增 `collections` 表）和接口逻辑更新。您可以直接全选复制，粘贴到您的 Word 文档 **`软件设计说明书_软工231_01_张某.doc`** 中。

------

# 软件设计说明书

## 1. 引言

### 1.1 编写目的

本说明书旨在详细阐述 **UniVideo（校园视界）** 系统的设计方案，包括系统架构、数据库设计、接口定义及核心业务逻辑。文档明确了系统的物理结构和逻辑结构，为后续的编码实现、测试及系统维护提供主要的技术依据。预期的读者包括项目开发人员、测试人员及指导教师。

### 1.2 项目背景

- **项目名称：** UniVideo 校园视界
- **开发者：** 软工231班 张某
- **项目性质：** 软件工程课程设计
- **技术栈：** 后端 Python (Flask), 前端 Vue.js, 数据库 MySQL 8.0

### 1.3 定义

- **先审后发 (Pre-audit)：** 指普通用户上传视频后，系统仅将状态置为“待审核”，只有经管理员后台确认通过后，视频才会在前台公开展示的机制。
- **管理员特权 (Admin Privilege)：** 指管理员上传视频可免去审核流程直接发布，且拥有对全站视频进行搜索和删除的最高权限。
- **根评论 (Root Comment)：** 指直接对视频发表的一级评论。
- **二级评论 (Nested Comment)：** 指对已有评论进行的回复。本系统通过 `root_id` 将同一楼层的所有回复关联，优化查询效率。

### 1.4 参考资料

1. 《软件工程课程设计指导书》
2. UniVideo 需求分析规格说明书
3. Flask 官方文档 (https://flask.palletsprojects.com/)

## 2. 总体设计

### 2.1 运行环境

- **操作系统：** Windows 10/11 或 Linux
- **Web 服务器：** Nginx (生产环境) 或 Flask Built-in Server (开发环境)
- **数据库服务器：** MySQL 8.0+
- **开发语言：** Python 3.8+, JavaScript (Vue 3)

### 2.2 系统架构设计

本系统采用标准的 **B/S (Browser/Server)** 架构，前后端分离开发：

- **前端 (Frontend)：** 使用 Vue.js 框架构建单页面应用 (SPA)，负责页面渲染、用户交互（搜索、播放、个人中心）。通过 Axios 与后端进行 HTTP 通信。
- **后端 (Backend)：** 使用 Python Flask 框架提供 RESTful API 接口，处理业务逻辑（如文件上传、权限验证、数据检索）。
- **数据库 (Database)：** MySQL 存储结构化数据，视频文件和图片资源直接存储于服务器本地文件系统 (`/static` 目录)。

### 2.3 功能模块结构

系统主要划分为 **前台用户子系统** 和 **后台管理子系统**：

1. **用户基础模块：** 注册、登录（Token鉴权）、个人资料修改（头像/昵称/密码）。
2. **视频浏览模块：**
   - **首页：** 分类标签导航（Tab切换）、关键词模糊搜索。
   - **详情：** 视频流媒体播放、点赞/收藏状态展示。
3. **内容创作模块：**
   - **投稿：** 视频/封面上传、元数据填写。
   - **个人作品管理：** “我的投稿”列表查看。
4. **互动社区模块：**
   - **评论：** 发表评论、回复评论（支持二级盖楼）。
   - **收藏/点赞：** 收藏视频至个人中心、点赞视频。
5. **后台管理模块：**
   - **审核：** 待审核视频列表、预览、通过/驳回操作。
   - **全站管理：** 搜索任意视频、物理删除违规视频。

## 3. 数据库设计 (Database Design)

### 3.1 逻辑结构设计

系统共设计 **6 张数据表**，均满足第三范式 (3NF)。

### 3.2 物理结构设计

数据库名：`univideo_db`，字符集：`utf8mb4`。

#### 1. 用户表 (`users`)

| **字段名**   | **类型** | **长度** | **空** | **键** | **描述**                              |
| ------------ | -------- | -------- | ------ | ------ | ------------------------------------- |
| `id`         | INT      | 11       | 否     | PK     | 自增主键                              |
| `username`   | VARCHAR  | 50       | 否     | UK     | 登录账号 (学号)                       |
| `password`   | VARCHAR  | 255      | 否     |        | 加密后的密码散列值                    |
| `nickname`   | VARCHAR  | 50       | 否     |        | 用户昵称                              |
| `role`       | VARCHAR  | 20       | 否     |        | 角色：`user` (普通), `admin` (管理员) |
| `avatar`     | VARCHAR  | 255      | 是     |        | 头像路径                              |
| `created_at` | DATETIME |          | 是     |        | 注册时间                              |

#### 2. 视频分类表 (`categories`)

| **字段名** | **类型** | **长度** | **空** | **键** | **描述**                          |
| ---------- | -------- | -------- | ------ | ------ | --------------------------------- |
| `id`       | INT      | 11       | 否     | PK     | 自增主键                          |
| `name`     | VARCHAR  | 50       | 否     | UK     | 分类名称 (如：校园生活、课程学习) |

#### 3. 视频信息表 (`videos`)

| **字段名**    | **类型** | **长度** | **空** | **键** | **描述**                       |
| ------------- | -------- | -------- | ------ | ------ | ------------------------------ |
| `id`          | INT      | 11       | 否     | PK     | 自增主键                       |
| `user_id`     | INT      | 11       | 否     | FK     | 上传用户 ID                    |
| `category_id` | INT      | 11       | 否     | FK     | 分类 ID                        |
| `title`       | VARCHAR  | 100      | 否     |        | 视频标题 (支持模糊搜索)        |
| `description` | TEXT     |          | 是     |        | 视频简介                       |
| `cover_path`  | VARCHAR  | 255      | 否     |        | 封面路径                       |
| `video_path`  | VARCHAR  | 255      | 否     |        | 视频文件路径                   |
| `status`      | TINYINT  | 4        | 是     | IDX    | **0=待审核, 1=已发布, 2=驳回** |
| `view_count`  | INT      | 11       | 是     |        | 播放次数                       |
| `created_at`  | DATETIME |          | 是     |        | 上传时间                       |

#### 4. 评论表 (`comments`)

引入 root_id 优化二级评论查询。

| 字段名 | 类型 | 长度 | 空 | 键 | 描述 |

| :--- | :--- | :--- | :--- | :--- | :--- |

| id | INT | 11 | 否 | PK | 自增主键 |

| user_id | INT | 11 | 否 | FK | 评论者 ID |

| video_id | INT | 11 | 否 | FK | 所属视频 ID |

| parent_id | INT | 11 | 是 | FK | 父评论 ID (直接回复的对象) |

| root_id | INT | 11 | 是 | FK | 根评论 ID (所属楼层 ID) |

| content | TEXT | | 否 | | 评论内容 |

| created_at | DATETIME | | 是 | | 评论时间 |

#### 5. 点赞表 (`likes`)

| **字段名**                                         | **类型** | **长度** | **空** | **键** | **描述** |
| -------------------------------------------------- | -------- | -------- | ------ | ------ | -------- |
| `id`                                               | INT      | 11       | 否     | PK     | 自增主键 |
| `user_id`                                          | INT      | 11       | 否     | FK     | 用户 ID  |
| `video_id`                                         | INT      | 11       | 否     | FK     | 视频 ID  |
| *约束：`UNIQUE(user_id, video_id)` 防止重复点赞。* |          |          |        |        |          |

#### 6. 收藏表 (`collections`) **[新增]**

| **字段名**                                         | **类型** | **长度** | **空** | **键** | **描述** |
| -------------------------------------------------- | -------- | -------- | ------ | ------ | -------- |
| `id`                                               | INT      | 11       | 否     | PK     | 自增主键 |
| `user_id`                                          | INT      | 11       | 否     | FK     | 用户 ID  |
| `video_id`                                         | INT      | 11       | 否     | FK     | 视频 ID  |
| `created_at`                                       | DATETIME |          | 是     |        | 收藏时间 |
| *约束：`UNIQUE(user_id, video_id)` 防止重复收藏。* |          |          |        |        |          |

## 4. 接口设计 (Interface Design)

### 4.1 认证与用户模块

- `POST /api/auth/register`: 注册
- `POST /api/auth/login`: 登录
- `GET /api/users/me`: 获取当前登录用户详情
- `PUT /api/users/me`: 修改个人资料 (头像/昵称/密码)
- `GET /api/users/me/videos`: 获取“我的投稿”列表
- `GET /api/users/me/collections`: 获取“我的收藏”列表

### 4.2 视频业务模块

- `POST /api/videos/upload`: 上传视频
  - *逻辑更新：* 若 `current_user.role == 'admin'`，直接置 `status=1`；否则置 `0`。
- `GET /api/videos`: 获取视频列表
  - *参数：* `page`, `category_id`, `keyword` (搜索词)
  - *逻辑：* 强制过滤 `status=1`。
- `GET /api/videos/categories`: 获取分类列表
- `GET /api/videos/<id>`: 获取视频详情

### 4.3 互动模块

- `POST /api/videos/<id>/comments`: 发表评论
- `GET /api/videos/<id>/comments`: 获取评论树
- `POST /api/videos/<id>/like`: 点赞/取消点赞
- `POST /api/videos/<id>/collect`: **收藏/取消收藏 [新增]**

### 4.4 管理员模块

- `GET /api/admin/manage/list`: 获取视频管理列表
  - *参数：* `status` (0=待审核, 1=已发布, null=全部), `keyword` (搜索)
- `POST /api/admin/audit/<id>`: 审核操作 (通过/驳回)
- `DELETE /api/admin/manage/video/<id>`: **删除视频 [新增]**
  - *逻辑：* 删除数据库记录并清理本地物理文件。

## 5. 详细设计 (Detailed Design)

### 5.1 智能上传逻辑

为提升管理效率，系统实现差异化上传策略：

Python

```
# 伪代码逻辑
if current_user.role == 'admin':
    video.status = 1  # 管理员免审，直接发布
else:
    video.status = 0  # 普通用户需等待审核
```

### 5.2 全文搜索与分类实现

前端通过 URL 参数传递筛选条件，后端使用 SQLAlchemy 动态构建查询：

Python

```
query = Video.query.filter_by(status=1)
if category_id:
    query = query.filter_by(category_id=category_id)
if keyword:
    query = query.filter(Video.title.like(f'%{keyword}%'))
return query.all()
```

### 5.3 个人中心与收藏逻辑

- **收藏交互：** 采用“Toggle”模式。前端点击收藏按钮 -> 后端查询 `collections` 表 -> 若存在则删除记录（取消收藏），若不存在则新增记录（添加收藏）。
- **个人主页：** 聚合展示用户信息及两个 Tab 页签（我的投稿、我的收藏），复用首页的视频卡片组件进行网格化展示。

### 5.4 评论区树状结构

后端查询时，先获取该视频下所有评论。遍历列表，若 `root_id` 为空，则作为顶级评论；若不为空，则将其挂载到对应的父级评论节点的 `children` 列表中，最终返回树形 JSON 数据。