# UniVideo 关注功能实现说明

## 📋 功能概述

成功实现了完整的用户关注系统，包括前后端全栈开发。用户可以关注其他用户、查看关注列表和粉丝列表，实现了类似 B 站的社交功能。

---

## 🔧 后端实现

### 1. 数据库模型 (`backend/models.py`)

#### 新增 Follow 模型
```python
class Follow(db.Model):
    __tablename__ = 'follows'
    
    # 联合主键
    follower_id = db.Column(db.Integer, db.ForeignKey('users.id'), primary_key=True)
    followed_id = db.Column(db.Integer, db.ForeignKey('users.id'), primary_key=True)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
    
    # 约束：不能自己关注自己
    __table_args__ = (
        db.CheckConstraint('follower_id != followed_id', name='check_no_self_follow'),
    )
```

#### User 模型扩展
- 添加 `followed` 关系：我关注的人
- 添加 `followers` 关系：关注我的人
- 添加辅助方法：
  - `follow(user)` - 关注某人
  - `unfollow(user)` - 取消关注
  - `is_following(user)` - 判断是否已关注

### 2. API 接口 (`backend/routes/interaction.py`)

#### 新增 5 个接口：

| 方法 | 路径 | 功能 | 参数 |
|------|------|------|------|
| POST | `/api/follow/<user_id>` | 关注用户 | `{user_id: 当前用户ID}` |
| POST | `/api/unfollow/<user_id>` | 取消关注 | `{user_id: 当前用户ID}` |
| GET | `/api/users/<user_id>/followers` | 获取粉丝列表 | `?page=1&per_page=20` |
| GET | `/api/users/<user_id>/following` | 获取关注列表 | `?page=1&per_page=20` |
| GET | `/api/users/<user_id>/follow_status` | 查询关注状态 | `?current_user_id=1` |

#### 响应格式示例：

**关注用户响应：**
```json
{
  "code": 200,
  "msg": "关注成功",
  "data": {
    "is_following": true
  }
}
```

**获取关注列表响应：**
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "total": 30,
    "page": 1,
    "per_page": 20,
    "pages": 2,
    "list": [
      {
        "id": 3,
        "username": "user002",
        "nickname": "李四",
        "avatar": "avatars/yyy.jpg",
        "followed_at": "2026-01-05T15:20:00"
      }
    ]
  }
}
```

### 3. 数据库迁移 (`univideo_db.sql`)

已将 follows 表集成到主数据库初始化脚本中：
```sql
/* 8. 关注关系表 */
CREATE TABLE IF NOT EXISTS `follows` (
  `follower_id` INT NOT NULL COMMENT '关注者ID',
  `followed_id` INT NOT NULL COMMENT '被关注者ID',
  `timestamp` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '关注时间',
  PRIMARY KEY (`follower_id`, `followed_id`),
  FOREIGN KEY (`follower_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`followed_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  CONSTRAINT `check_no_self_follow` CHECK (`follower_id` != `followed_id`),
  INDEX `idx_follower` (`follower_id`),
  INDEX `idx_followed` (`followed_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户关注关系表';
```

---

## 🎨 前端实现

### 1. API 封装 (`frontend/src/api.js`)

新增 5 个 API 方法：
```javascript
// 关注用户
export const followUser = (targetUserId, currentUserId)

// 取消关注用户
export const unfollowUser = (targetUserId, currentUserId)

// 获取粉丝列表
export const getFollowers = (userId, page = 1, perPage = 20)

// 获取关注列表
export const getFollowing = (userId, page = 1, perPage = 20)

// 查询关注状态
export const getFollowStatus = (targetUserId, currentUserId)
```

### 2. 视频详情页 (`VideoDetail.vue`)

#### 功能实现：
- ✅ 在 UP 主卡片中添加关注按钮
- ✅ 页面加载时自动获取关注状态
- ✅ 点击按钮可关注/取消关注
- ✅ 按钮状态实时更新（已关注/未关注）
- ✅ 自己的视频不显示关注按钮

#### UI 样式：
- **未关注**：蓝色背景，显示 "+ 关注"
- **已关注**：灰色背景，显示 "✓ 已关注"
- **悬停效果**：按钮上浮、阴影效果

### 3. 作者主页 (`AuthorPage.vue`)

#### 功能实现：
- ✅ 在作者信息卡片中添加关注按钮
- ✅ 页面加载时自动获取关注状态
- ✅ 点击按钮可关注/取消关注
- ✅ 按钮状态实时更新
- ✅ 查看自己的主页不显示关注按钮

#### UI 样式：
- 圆角按钮设计，与个人主页风格统一
- 关注状态颜色区分明显

### 4. 个人中心 (`Profile.vue`)

#### 新增功能：
- ✅ 新增 "我的关注" 标签页
- ✅ 新增 "我的粉丝" 标签页
- ✅ 显示关注/粉丝总数
- ✅ 列表展示用户信息（头像、昵称、学号）
- ✅ 每个用户都有关注/取消关注按钮
- ✅ 支持互粉状态管理

#### 用户列表功能：
- **点击头像/昵称**：跳转到该用户的主页
- **关注按钮**：
  - 蓝色 "关注" - 未关注状态
  - 灰色 "已关注" - 已关注状态
- **在关注列表页取消关注**：自动从列表中移除

#### UI 设计：
```
┌─────────────────────────────────────┐
│ [我的投稿] [我的收藏] [我的关注] [我的粉丝] │
├─────────────────────────────────────┤
│  👤 张三                [关注]      │
│     学号：202201001                 │
│                                     │
│  👤 李四                [已关注]    │
│     学号：202201002                 │
└─────────────────────────────────────┘
```

---

## ✨ 功能特性

### 数据库层面
1. ✅ **防止自己关注自己**：数据库约束 + 应用层双重校验
2. ✅ **关注时间记录**：记录每次关注的时间戳
3. ✅ **级联删除**：用户删除时自动清理关注关系
4. ✅ **性能优化**：为高频查询添加索引
5. ✅ **分页支持**：粉丝和关注列表都支持分页

### 前端交互
1. ✅ **状态实时更新**：关注/取消关注后按钮立即变化
2. ✅ **无需刷新页面**：所有操作都是异步完成
3. ✅ **用户反馈**：操作成功/失败都有提示
4. ✅ **防重复提交**：操作进行中按钮禁用
5. ✅ **权限控制**：未登录用户点击关注会跳转登录页

### 业务逻辑
1. ✅ **不能关注自己**：前后端双重验证
2. ✅ **防重复关注**：已关注状态下不能重复关注
3. ✅ **互粉检测**：粉丝列表可以看到是否已回关
4. ✅ **状态同步**：多个页面的关注状态保持一致

---

## 🧪 测试指南

### 1. 数据库测试

```bash
# 方式一：首次初始化（推荐）
# 执行主 SQL 文件，创建所有表（包括 follows 表）
mysql -u root -p < univideo_db.sql

# 方式二：如果数据库已存在，只添加 follows 表
mysql -u root -p univideo_db << 'EOF'
CREATE TABLE IF NOT EXISTS `follows` (
  `follower_id` INT NOT NULL COMMENT '关注者ID',
  `followed_id` INT NOT NULL COMMENT '被关注者ID',
  `timestamp` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '关注时间',
  PRIMARY KEY (`follower_id`, `followed_id`),
  FOREIGN KEY (`follower_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`followed_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  CONSTRAINT `check_no_self_follow` CHECK (`follower_id` != `followed_id`),
  INDEX `idx_follower` (`follower_id`),
  INDEX `idx_followed` (`followed_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户关注关系表';
EOF

# 方式三：使用 Flask-Migrate（如果使用了迁移工具）
cd backend
source venv/bin/activate
flask db migrate -m "添加用户关注功能"
flask db upgrade
```

### 2. 后端 API 测试

```bash
# 1. 关注用户 (用户1关注用户2)
curl -X POST http://localhost:5001/api/follow/2 \
  -H "Content-Type: application/json" \
  -d '{"user_id": 1}'

# 2. 查询关注状态
curl "http://localhost:5001/api/users/2/follow_status?current_user_id=1"

# 3. 获取用户2的粉丝列表
curl "http://localhost:5001/api/users/2/followers?page=1&per_page=20"

# 4. 获取用户1的关注列表
curl "http://localhost:5001/api/users/1/following?page=1&per_page=20"

# 5. 取消关注
curl -X POST http://localhost:5001/api/unfollow/2 \
  -H "Content-Type: application/json" \
  -d '{"user_id": 1}'
```

### 3. 前端功能测试

#### 测试场景 1：视频详情页关注
1. 登录系统
2. 打开任意视频
3. 查看右侧 UP 主卡片
4. 点击 "关注" 按钮
5. 验证：按钮变为 "已关注"，颜色变灰
6. 再次点击，验证：按钮变回 "关注"

#### 测试场景 2：作者主页关注
1. 登录系统
2. 点击任意视频的 UP 主名称
3. 进入作者主页
4. 点击右上角的 "关注" 按钮
5. 验证：按钮状态正确切换

#### 测试场景 3：个人中心关注列表
1. 登录系统
2. 点击导航栏的 "个人中心"
3. 点击 "我的关注" 标签
4. 查看关注列表
5. 点击某个用户的 "已关注" 按钮取消关注
6. 验证：该用户从列表中移除

#### 测试场景 4：个人中心粉丝列表
1. 登录系统
2. 点击 "我的粉丝" 标签
3. 查看粉丝列表
4. 对未关注的粉丝点击 "关注" 按钮
5. 验证：按钮变为 "已关注"

#### 测试场景 5：自己不能关注自己
1. 登录系统
2. 上传一个视频
3. 查看自己的视频详情
4. 验证：右侧 UP 主卡片不显示关注按钮
5. 访问自己的作者主页
6. 验证：不显示关注按钮

---

## 📂 文件修改清单

### 后端文件
- ✅ `backend/models.py` - 添加 Follow 模型和 User 关注方法
- ✅ `backend/routes/interaction.py` - 添加关注相关 API
- ✅ `univideo_db.sql` - 主数据库脚本（已包含 follows 表）

### 前端文件
- ✅ `frontend/src/api.js` - 添加关注 API 封装
- ✅ `frontend/src/views/VideoDetail.vue` - 视频详情页添加关注按钮
- ✅ `frontend/src/views/AuthorPage.vue` - 作者主页添加关注按钮
- ✅ `frontend/src/views/Profile.vue` - 个人中心添加关注/粉丝列表

---

## 🚀 启动步骤

### 1. 数据库初始化

```bash
# 首次初始化（创建数据库和所有表，包括 follows 表）
mysql -u root -p < univideo_db.sql

# 或者如果数据库已存在，只添加 follows 表（见上文"数据库测试"部分）
```

### 2. 后端启动

```bash
cd backend

# 激活虚拟环境
source venv/bin/activate

# 启动后端服务
python app.py
```

### 3. 前端启动

```bash
cd frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev
```

### 4. 访问系统

- 前端地址：http://localhost:5173
- 后端 API：http://localhost:5001/api

---

## 📸 功能截图说明

### 视频详情页关注按钮
- 位置：右侧 UP 主卡片
- 样式：蓝色/灰色圆角按钮
- 状态：未关注/已关注

### 作者主页关注按钮
- 位置：作者信息卡片右上角
- 样式：大号圆角按钮
- 交互：点击切换状态

### 个人中心关注列表
- 标签页：我的投稿 | 我的收藏 | 我的关注 | 我的粉丝
- 列表项：头像 + 昵称 + 学号 + 关注按钮
- 交互：点击头像/昵称跳转主页

---

## 🎯 核心亮点

1. **完整的前后端实现**：从数据库到 UI 完整实现
2. **实时状态更新**：无需刷新页面，操作立即生效
3. **优雅的 UI 设计**：符合 B 站风格，用户体验流畅
4. **健壮的错误处理**：完善的异常处理和用户提示
5. **性能优化**：数据库索引、分页查询、状态缓存
6. **安全性**：防止自己关注自己、防重复关注

---

## 📝 注意事项

1. **数据库初始化**：首次使用前必须执行 `univideo_db.sql` 创建所有表（包括 follows 表）
2. **数据库已存在**：如果数据库已经创建过，只需要单独添加 follows 表（见上文"数据库测试"部分）
3. **用户登录**：必须登录后才能使用关注功能
4. **权限控制**：不能关注自己
5. **状态同步**：在不同页面的关注状态会保持一致

---

## 🔮 未来扩展建议

1. **实时通知**：被关注时发送通知
2. **互粉标识**：在列表中显示互粉标记
3. **关注推荐**：基于关注关系推荐用户
4. **数据统计**：展示关注数和粉丝数的变化趋势
5. **批量操作**：支持批量关注/取消关注

---

## 📞 技术支持

如有问题，请检查：
1. ✅ 数据库表是否正确创建
2. ✅ 后端服务是否正常运行
3. ✅ 前端 API 地址是否正确配置
4. ✅ 浏览器控制台是否有错误信息

---

**实现完成！🎉 现在你的 UniVideo 拥有了完整的用户关注功能！**
