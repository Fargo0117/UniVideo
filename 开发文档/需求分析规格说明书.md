# 需求分析规格说明书

**目录**
(请保留原Word模板中的自动目录)

---

## 1. 引言

### 1.1 编写目的

本文档详细描述了 **UniVideo（校园视界）** 系统的功能需求、性能需求、数据需求及运行环境。其编写目的是为了明确系统"做什么"，界定系统功能边界，为后续的系统设计、编码实现、测试验收提供统一的标准和依据。
预期的读者包括：

* 项目开发人员（李梓豪）
* 软件测试人员
* 软件工程课程设计指导教师

### 1.2 背景

* **a. 待开发的软件系统的名称：** UniVideo 校园视界（校园视频分享平台）
* **b. 本项目的任务提出者：** 软件工程课程设计指导教师
* **开发者：** 软件工程234班 李梓豪 (学号: 2318140407)
* **用户：** 大连交通大学全校师生、系统管理员

* **c. 该软件系统同其他系统或其他机构的基本的相互来往关系：** 本系统独立运行，不依赖外部第三方账号体系。系统运行于校园局域网或互联网环境，通过 HTTP 协议与客户端浏览器进行数据交互。

### 1.3 定义

* **RBAC (Role-Based Access Control)：** 基于角色的访问控制。本系统分为普通用户（User）和管理员（Admin）两种角色，拥有不同的操作权限。
* **Pre-audit（先审后发）：** 指视频上传后默认状态不可见，必须经管理员后台审核通过后，方可在前台展示的机制。管理员上传的视频可直接发布，无需审核。
* **Nested Comment（盖楼/嵌套评论）：** 指评论区支持对已有评论进行回复，形成树状结构的交流形式。通过 `parent_id` 和 `root_id` 字段实现多级评论。
* **Canvas Snapshot（前端截图）：** 指利用 HTML5 Canvas 技术在浏览器端截取视频当前帧作为封面的技术。
* **Danmaku（弹幕）：** 指在视频播放过程中实时显示的滚动文字评论，支持自定义颜色、位置和模式。
* **Follow（关注）：** 指用户之间建立关注关系，可查看关注用户的视频动态。
* **Notification（通知）：** 系统向用户推送的消息，包括审核通知、系统公告等类型。

### 1.4 参考资料

* **a.** 《软件工程课程设计指导书》，大连交通大学软件工程教研室，2025。
* **b.** UniVideo 系统《可行性分析与开发计划》。
* **c.** UniVideo 系统《软件设计说明书》。
* **d.** GB/T 8567-2006 《计算机软件文档编制规范》。
* **e.** Vue.js 3.0 官方文档、Flask 2.0 官方文档、ArtPlayer 播放器文档。

## 2. 任务概述

### 2.1 目标

本系统的开发意图是构建一个基于 B/S 架构的校园视频资源管理与分享平台，旨在解决当前校园内视频文件（如课程录像、社团活动、新闻资讯）存储分散、传播困难、缺乏互动的问题。
本软件产品是一项独立的 Web 应用系统，全部内容自含。前端通过 RESTful API 与后端进行通信，数据库负责持久化存储。

系统核心功能包括：
* 用户注册登录与个人资料管理
* 视频上传、审核、发布与播放
* 视频分类浏览与关键词搜索
* 用户搜索（按用户名/昵称）
* 视频点赞、收藏、评论（支持多级回复）
* 弹幕发送与实时显示
* 用户关注与粉丝管理
* 个人中心（我的投稿、我的收藏、我的关注、我的粉丝）
* 消息中心（审核通知、系统公告）
* 管理员后台（视频审核、用户管理、数据统计、通知发送）

### 2.2 用户的特点

* **普通用户（学生/教师）：**
* **特点：** 数量庞大，计算机操作水平参差不齐。
* **预期频度：** 每天高频访问。
* **需求：** 界面必须直观简洁，视频加载速度快，上传操作简单（如支持自动截图封面）。

* **系统管理员：**
* **特点：** 数量较少，具备一定的系统维护知识。
* **预期频度：** 每天定期访问后台。
* **需求：** 审核效率高，能快速检索和处理违规内容，支持批量操作和统计分析。

### 2.3 假定和约束

* **开发期限：** 2周（14天）。
* **技术约束：** 后端采用 Python (Flask) 框架，前端采用 Vue.js 3 框架，数据库采用 MySQL。
* **硬件约束：** 受限于实验环境，视频文件存储于服务器本地文件系统（`/static` 目录），不使用云对象存储服务。
* **网络约束：** 假设用户处于稳定的网络环境中，带宽足以支持 720P 视频流播放。
* **身份认证约束：** 采用简化的身份认证机制，通过 HTTP Header (`X-User-ID`) 传递用户ID，用户信息存储在客户端 LocalStorage 中。

### 2.4 可行性分析

根据《可行性分析与开发计划》，本项目在技术上利用成熟的 Web 开发栈实现；经济上零成本；法律上通过审核机制规避版权和合规风险。因此项目完全可行。

## 3. 需求规定

### 3.1 对功能的规定

本系统主要划分为 **用户前台** 和 **管理后台** 两个子系统。以下采用 IPO（输入-处理-输出）描述主要功能需求：

#### 3.1.1 用户认证模块

| 功能名称 | 输入 | 处理逻辑 | 输出 |
| --- | --- | --- | --- |
| **用户注册** | 学号（用户名）、昵称、密码 | 1. 校验学号唯一性（3-50字符）；<br>2. 校验密码长度（至少6位）；<br>3. 密码进行 Hash 加密存储（Werkzeug pbkdf2:sha256）；<br>4. 默认角色为 `user`，状态为正常（`status=1`）。 | 注册成功提示，返回用户ID和基本信息，跳转登录页 |
| **用户登录** | 学号、密码 | 1. 校验账号密码匹配度；<br>2. 检查用户状态（被封禁用户无法登录）；<br>3. 返回用户信息（ID、用户名、昵称、角色、头像）。 | 返回用户信息，前端存储到 LocalStorage，跳转首页 |
| **获取当前用户信息** | HTTP Header: `X-User-ID` | 根据用户ID查询数据库，返回完整用户信息 | 用户详细信息（含头像URL） |
| **个人资料修改** | 新头像（可选）、新昵称（可选）、新密码（可选） | 1. 校验昵称长度（2-50字符）；<br>2. 如修改密码，校验长度（至少6位）并加密；<br>3. 如上传头像，保存到 `avatars/` 目录；<br>4. 更新数据库记录。 | 更新成功提示，返回更新后的用户信息，界面刷新 |

#### 3.1.2 视频业务模块

| 功能名称 | 输入 | 处理逻辑 | 输出 |
| :----------- | :---------------------------------------------- | :----------------------------------------------------------- | :--------------------------------- |
| **视频上传** | 视频文件、封面图、标题、简介、分类ID | 1. 验证文件格式（视频：mp4/avi/mov/mkv/flv/wmv；封面：jpg/jpeg/png/gif/webp）；<br>2. 生成唯一文件名（时间戳+UUID）；<br>3. 保存文件到本地（`videos/` 和 `covers/` 目录）；<br>4. 判别角色：管理员直接发布（`status=1`），普通用户置为待审核（`status=0`）；<br>5. 写入数据库。 | 上传成功提示，状态反馈（"已直接发布"或"等待审核"） |
| **获取视频分类** | 无 | 查询所有分类列表 | 分类列表（ID、名称） |
| **视频浏览（首页）** | 分类ID（可选）、关键词（可选） | 1. 查询 `status=1`（已发布）的视频；<br>2. 排除被封禁用户（`user.status=0`）的视频；<br>3. 如提供分类ID，按分类筛选；<br>4. 如提供关键词，模糊匹配标题；<br>5. 按上传时间倒序排列。 | 视频卡片列表（含封面URL、标题、作者、分类、播放量、点赞数、收藏数） |
| **视频搜索** | 搜索关键词 | 1. 模糊匹配视频标题（`LIKE '%keyword%'`）；<br>2. 仅返回已发布且作者正常的视频；<br>3. 按时间倒序排列。 | 符合条件的视频列表 |
| **视频详情** | 视频ID | 1. 查询视频详细信息（含作者、分类）；<br>2. 播放量自动+1；<br>3. 计算点赞数和收藏数；<br>4. 返回完整视频URL和封面URL。 | 视频详情（含播放地址、封面地址、作者信息、统计数据） |
| **用户搜索** | 搜索关键词 | 1. 模糊匹配用户名或昵称；<br>2. 仅返回正常用户（`status=1`）；<br>3. 按注册时间倒序，限制返回数量（默认20）。 | 用户列表（ID、用户名、昵称、头像URL） |

#### 3.1.3 社区互动模块

| 功能名称 | 输入 | 处理逻辑 | 输出 |
| :------------ | :--------------------------- | :----------------------------------------------------------- | :------------------------------ |
| **发表评论** | 评论内容、父评论ID（可选）、视频ID | 1. 识别是主评（`parent_id=null`）还是回复（`parent_id` 有值）；<br>2. 计算 `root_id`：主评为 `null`，回复继承父评论的 `root_id`；<br>3. 写入数据库；<br>4. 返回评论信息（含作者信息）。 | 评论列表实时更新显示新评论 |
| **获取评论列表** | 视频ID | 1. 查询该视频的所有评论；<br>2. 按创建时间升序排列；<br>3. 包含作者信息（昵称、头像）。 | 评论列表（支持前端构建树状结构） |
| **点赞/取消点赞** | 用户ID、视频ID | 1. 查询关联表（`likes`），检查是否已点赞；<br>2. 若已存在则删除（取消点赞），不存在则新增；<br>3. 重新计算点赞总数。 | 按钮状态改变（已点赞/未点赞），点赞数实时更新 |
| **收藏/取消收藏** | 用户ID、视频ID | 1. 查询关联表（`collections`），检查是否已收藏；<br>2. 若已存在则删除（取消收藏），不存在则新增；<br>3. 重新计算收藏总数。 | 按钮状态改变（已收藏/未收藏），收藏数实时更新 |
| **获取点赞状态** | 用户ID、视频ID | 查询 `likes` 表，判断是否已点赞 | 布尔值（`liked: true/false`） |
| **获取收藏状态** | 用户ID、视频ID | 查询 `collections` 表，判断是否已收藏 | 布尔值（`collected: true/false`） |
| **发送弹幕** | 用户ID、视频ID、弹幕文本、时间（秒）、颜色、模式 | 1. 验证弹幕内容长度（≤100字符）；<br>2. 保存到 `danmaku` 表；<br>3. 返回弹幕信息（兼容 ArtPlayer 格式）。 | 弹幕发送成功，播放器实时显示 |
| **获取弹幕列表** | 视频ID | 1. 查询该视频的所有弹幕；<br>2. 按时间（`time` 字段）升序排列；<br>3. 转换为 ArtPlayer 弹幕插件要求的格式。 | 弹幕数组（含文本、时间、颜色、模式等） |
| **关注用户** | 当前用户ID、目标用户ID | 1. 验证不能关注自己；<br>2. 检查是否已关注；<br>3. 在 `follows` 表创建记录。 | 关注成功，关注状态更新 |
| **取消关注** | 当前用户ID、目标用户ID | 1. 检查是否已关注；<br>2. 从 `follows` 表删除记录。 | 取消关注成功，关注状态更新 |
| **获取关注状态** | 当前用户ID、目标用户ID | 查询 `follows` 表，判断是否已关注 | 布尔值（`is_following: true/false`） |
| **获取关注列表** | 用户ID、页码、每页数量 | 1. 查询该用户关注的所有用户；<br>2. 分页返回；<br>3. 包含用户基本信息（昵称、头像、关注时间）。 | 关注列表（分页信息+用户列表） |
| **获取粉丝列表** | 用户ID、页码、每页数量 | 1. 查询关注该用户的所有用户；<br>2. 分页返回；<br>3. 包含用户基本信息（昵称、头像、关注时间）。 | 粉丝列表（分页信息+用户列表） |

#### 3.1.4 个人中心模块

| 功能名称 | 输入 | 处理逻辑 | 输出 |
| :----------- | :------------ | :--------------------------------------------------------- | :--------------------------- |
| **我的投稿** | 用户ID | 1. 查询该用户上传的所有视频（含各种状态）；<br>2. 按上传时间倒序排列；<br>3. 包含视频状态标签（待审核/已发布/已驳回）。 | 我的投稿列表（含状态、播放量、点赞数） |
| **我的收藏** | 用户ID | 1. 通过 `collections` 关联表查询；<br>2. 仅返回已发布状态的视频；<br>3. 按收藏时间倒序排列。 | 我收藏的视频列表（含作者信息） |
| **我的关注** | 用户ID | 调用关注列表接口 | 我关注的用户列表 |
| **我的粉丝** | 用户ID | 调用粉丝列表接口 | 我的粉丝列表 |
| **作者主页** | 作者用户ID | 1. 查询作者基本信息；<br>2. 查询作者发布的已发布视频；<br>3. 按上传时间倒序排列。 | 作者信息和视频列表 |

#### 3.1.5 后台管理模块

| 功能名称 | 输入 | 处理逻辑 | 输出 |
| :----------- | :------------ | :--------------------------------------------------------- | :--------------------------- |
| **获取统计数据** | 无 | 1. 统计待审核视频数；<br>2. 统计总用户数；<br>3. 统计今日新增视频数。 | 统计数据（JSON格式） |
| **获取数据趋势** | 无 | 1. 统计最近7天每天的新增用户数；<br>2. 统计最近7天每天的新增视频数；<br>3. 返回日期数组和对应数据数组。 | 趋势数据（用于图表展示） |
| **视频审核列表** | 状态筛选（可选）、关键词（可选） | 1. 如提供状态，按状态筛选（0=待审核，1=已发布，2=已驳回）；<br>2. 如提供关键词，模糊匹配标题；<br>3. 按上传时间倒序排列。 | 视频管理列表（含所有状态） |
| **视频审核** | 视频ID、操作（通过/驳回）、驳回理由（可选） | 1. 验证视频状态（仅待审核可审核）；<br>2. 更新视频状态（通过=1，驳回=2）；<br>3. 创建审核通知（发送给上传者）；<br>4. 如驳回，记录驳回理由。 | 审核成功提示，列表刷新，用户收到通知 |
| **视频删除** | 视频ID | 1. 删除数据库记录（级联删除相关评论、点赞、收藏、弹幕）；<br>2. 物理删除磁盘上的视频和封面文件；<br>3. 如文件删除失败，记录日志但不影响数据库删除。 | 删除成功提示，列表刷新 |
| **用户列表** | 页码、每页数量、关键词（可选） | 1. 如提供关键词，模糊匹配用户名或昵称；<br>2. 分页查询；<br>3. 统计每个用户的视频数；<br>4. 按注册时间倒序排列。 | 用户列表（分页信息+用户列表+视频数统计） |
| **用户状态管理** | 用户ID、状态（0=封禁，1=正常） | 1. 验证不能封禁管理员；<br>2. 更新用户状态；<br>3. 封禁后该用户的所有视频在前台不可见。 | 操作成功提示，列表刷新 |
| **发送通知** | 目标用户名（可选）、标题、内容、消息类型、关联链接（可选） | 1. 如提供用户名，发送个人通知；<br>2. 如不提供，发送系统通知（全员可见）；<br>3. 创建 `notifications` 记录。 | 发送成功提示 |
| **获取通知列表** | 用户ID（可选）、已读状态筛选（可选）、分页参数 | 1. 如提供用户ID，返回个人通知+系统通知；<br>2. 如不提供，仅返回系统通知；<br>3. 按创建时间倒序排列；<br>4. 支持已读/未读筛选。 | 通知列表（分页信息+通知列表） |
| **标记通知已读** | 通知ID | 更新 `is_read` 字段为 `true` | 标记成功 |
| **标记所有通知已读** | 用户ID（可选） | 批量更新未读通知为已读 | 更新数量 |
| **获取未读通知数** | 用户ID（可选） | 统计未读通知数量（个人+系统） | 未读数量 |

### 3.2 对性能的规定

#### 3.2.1 精度

* **时间精度：** 视频播放进度精确到秒；弹幕时间精确到浮点数（秒）。
* **数据精度：** 播放量、点赞数、收藏数精确到个位；用户ID、视频ID等主键为整数。
* **文件命名精度：** 使用时间戳（精确到秒）+ UUID（8位）确保文件名唯一性。

#### 3.2.2 时间特性要求

* **a. 响应时间：** 页面加载时间 < 1秒；API 接口平均响应时间 < 200毫秒。
* **b. 视频起播时间：** 在局域网环境下，点击播放后缓冲时间 < 3秒。
* **c. 搜索响应：** 关键词搜索结果返回时间 < 0.5秒。
* **d. 文件上传：** 视频文件上传进度实时反馈，上传完成后3秒内返回结果。
* **e. 弹幕同步：** 弹幕发送后1秒内显示在播放器中。

#### 3.2.3 灵活性

* **a. 运行环境的变化：** 前端采用响应式布局，应能适应不同分辨率的 PC 浏览器窗口（支持1920px+、1600px、1200px、768px、600px、400px等断点）。
* **b. 接口变化：** 后端 API 设计遵循 RESTful 规范，具备版本扩展能力（如 `/api/v1/`）。
* **c. 文件格式扩展：** 视频和图片格式支持列表可在配置文件中灵活配置。
* **d. 分页参数：** 支持自定义每页数量，默认值可配置。

### 3.3 输入输出要求

* **视频输入：** 格式限制为 mp4、avi、mov、mkv、flv、wmv，单文件大小建议 < 500MB。
* **图片输入：** 格式支持 jpg、jpeg、png、gif、webp，单文件大小 < 10MB（封面），头像 < 5MB。
* **文本输入：** 
  * 视频标题：最大100字符
  * 视频简介：最大500字符
  * 评论内容：最大500字符
  * 弹幕内容：最大100字符
  * 用户昵称：2-50字符
  * 用户名（学号）：3-50字符
* **API 输出：** 统一采用 JSON 格式，结构示例：
  ```json
  {
    "code": 200,
    "msg": "操作成功",
    "data": {...}
  }
  ```
  * 成功：`code=200`
  * 客户端错误：`code=400/401/403/404/409`
  * 服务器错误：`code=500`
* **异常输出：** 当发生错误时，需返回清晰的错误码和用户可读的提示信息（如"账号不存在"而非"404 Not Found"）。
* **文件输出：** 视频和图片文件通过静态资源服务提供，URL格式：`http://localhost:5001/static/{相对路径}`。

### 3.4 数据管理能力要求

* **数据库表结构：** 系统设计九张核心表：
  * `users`（用户表）
  * `categories`（分类表）
  * `videos`（视频表）
  * `comments`（评论表，支持多级评论）
  * `likes`（点赞表）
  * `collections`（收藏表）
  * `danmaku`（弹幕表）
  * `follows`（关注表）
  * `notifications`（通知表）
* **规模估算：**
  * 用户表：预估支持 1000+ 用户。
  * 视频表：预估支持 5000+ 视频记录。
  * 评论表：预估支持 10万+ 评论记录。
  * 点赞/收藏表：预估支持 20万+ 交互记录。
  * 弹幕表：预估支持 5万+ 弹幕记录。
  * 关注表：预估支持 1万+ 关注关系。
  * 通知表：预估支持 1万+ 通知记录。
* **存储要求：** 随着视频数量增长，需预留 TB 级硬盘空间。数据库需定期备份。建议使用索引优化高频查询（如视频列表、评论查询、关注关系查询）。

### 3.5 故障处理要求

* **网络中断：** 前端应提示"网络连接异常"，并允许用户点击重试。使用 Axios 拦截器统一处理网络错误。
* **上传失败：** 若因文件过大或格式错误导致上传中断，系统应通过 HTTP 状态码（413/415）或 JSON 错误消息反馈具体原因，严禁导致服务器崩溃。
* **数据库宕机：** 后端应捕获连接异常（SQLAlchemy 异常），向前端返回"服务暂不可用"提示（`code=500`）。
* **文件系统错误：** 如磁盘空间不足或文件权限错误，应记录日志并返回明确的错误提示，不影响其他功能正常运行。
* **并发冲突：** 点赞、收藏等操作使用数据库唯一约束防止重复，如发生冲突返回友好提示。

### 3.6 其他专门要求

* **安全保密：** 
  * 用户密码必须加盐哈希（采用 Werkzeug 的 `pbkdf2:sha256` 算法）存储，不可明文存储。
  * 所有管理接口必须校验管理员权限（通过 `X-User-ID` Header 验证角色）。
  * 普通用户无法访问管理后台路由。
  * 被封禁用户（`status=0`）无法登录，其视频在前台不可见。
* **易用性：** 
  * 视频上传支持文件选择，视频封面支持自动截取（Canvas 截图）或手动上传，减少用户操作步骤。
  * 封面图片支持裁切功能（16:9比例），头像支持裁切功能（1:1比例）。
  * 评论支持多级回复，界面清晰展示评论层级。
  * 弹幕支持实时发送和显示，兼容 ArtPlayer 播放器。
* **可维护性：** 
  * 代码采用模块化设计，前后端分离，便于维护和扩展。
  * 数据库模型使用 SQLAlchemy ORM，便于迁移和版本管理。
  * 配置文件集中管理（`config.py`），便于环境切换。
* **可扩展性：** 
  * API 接口遵循 RESTful 规范，便于后续功能扩展。
  * 数据库表结构设计合理，支持未来功能扩展（如视频标签、视频推荐等）。

## 4. 运行环境规定

### 4.1 设备

* **服务器端：**
* **a. 处理器：** Intel Core i5 或同级以上 CPU。
* **b. 内存：** 建议 8GB 或以上。
* **c. 外存：** 建议 512GB SSD 或以上，用于存储视频文件。视频文件存储在 `backend/static/` 目录下，需预留足够空间。

* **客户端：**
* 任何安装有现代浏览器的 PC 或笔记本电脑（推荐 Chrome 80+, Edge, Firefox, Safari）。
* 支持 HTML5 视频播放和 Canvas API 的浏览器。

### 4.2 支持软件

* **操作系统：** Windows 10/11, macOS, 或 Linux (Ubuntu/CentOS)。
* **数据库系统：** MySQL 8.0 Community Edition 或以上版本。
* **开发语言环境：** 
  * Python 3.8+ (后端开发)
  * Node.js 16+ (前端开发阶段，使用 Vite 构建工具)
* **Web 服务器：** 
  * 开发环境：Flask Built-in Server (端口 5001)
  * 生产环境：建议使用 Nginx + Gunicorn 或 uWSGI
* **前端构建工具：** Vite 4.0+
* **第三方库：** 
  * 后端：Flask, SQLAlchemy, Werkzeug, Flask-CORS, Flask-Migrate
  * 前端：Vue 3, Vue Router, Axios, ArtPlayer, ECharts (管理员统计图表)

### 4.3 接口

* **通信协议：** HTTP/1.1 (未来可升级 HTTPS)。
* **数据交换：** 前后端完全分离，通过 JSON 格式交换数据。
* **身份认证：** 通过 HTTP Header `X-User-ID` 传递用户ID，用户信息存储在客户端 LocalStorage 中。
* **跨域支持：** 后端启用 CORS，允许前端跨域访问。
* **静态资源：** 视频、图片、头像等静态文件通过 Flask 静态文件服务提供，URL 前缀为 `/static/`。

### 4.4 控制

* **会话控制：** 系统采用简化的身份认证机制。用户登录后，用户ID和角色信息存储在客户端 LocalStorage 中。每次 API 请求通过 HTTP Header `X-User-ID` 传递用户ID，后端根据用户ID查询数据库验证身份和权限。
* **路由守卫：** 前端使用 Vue Router 的 `beforeEach` 守卫，检查需要登录或管理员权限的路由，未授权用户自动跳转到登录页或首页。
* **权限控制：** 
  * 管理员接口使用装饰器 `@admin_required` 验证管理员权限。
  * 普通用户无法访问 `/admin/*` 路由。
  * 被封禁用户无法登录系统。
* **并发控制：** 数据库采用 InnoDB 引擎，利用行级锁和唯一约束处理高并发下的点赞、收藏、关注等操作，防止重复数据。
* **事务控制：** 关键操作（如视频上传、审核、删除）使用数据库事务，确保数据一致性。如发生异常，自动回滚。
