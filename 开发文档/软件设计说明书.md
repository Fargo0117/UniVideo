## 1. 引言

### 1.1 编写目的

本《软件设计说明书》用于说明“**UniVideo 校园视界**”系统的总体设计和详细设计方案。  
文档在《可行性分析与开发计划》《需求分析规格说明书》的基础上，给出系统的整体架构、模块划分、数据结构、接口设计与运行方案，为后续编码实现、联调测试和维护扩展提供统一依据。  
预期读者包括：课程设计指导教师、项目开发人员（软工234班 李梓豪）、后续维护人员以及评审人员。

### 1.2 项目背景

- **项目名称**：UniVideo 校园视界（校园视频分享平台）  
- **任务提出者**：软件工程课程设计指导教师  
- **开发者**：软件工程234班 李梓豪（学号：2318140407）  
- **用户对象**：在校师生（普通用户）、系统管理员  
- **与其他系统关系**：系统为独立的 B/S 结构 Web 应用，不直接依赖其他业务系统；仅依赖底层运行环境（操作系统、Python 解释器、MySQL 数据库）和浏览器。

### 1.3 定义与缩写

- **UniVideo**：本项目的系统名称。  
- **Pre-audit（先审后发）**：普通用户上传的视频需经管理员审核通过后才对全站可见的机制。  
- **Admin（管理员）**：具有上传免审、审核视频、封禁用户、发送公告、查看统计报表等高级权限的角色。  
- **Notification（通知）**：系统向用户推送的消息，含系统公告、审核结果通知等。  
- **Danmaku（弹幕）**：用户在观看视频过程中发送的实时漂浮评论，前端集成 ArtPlayer 弹幕插件展示。  
- **Follow / Follower / Following（关注 / 粉丝 / 关注列表）**：用户之间的社交关系，本系统支持用户之间互相关注。  
- **RESTful API**：后端提供的基于 HTTP 的资源风格接口，统一以 `/api/...` 为前缀。

### 1.4 参考资料

- 《可行性分析与开发计划_软工231_01_张某.doc》及其 Markdown 版本  
- 《需求分析规格说明书_软工231_01_张某.doc》及其 Markdown 版本  
- GB/T 8567-2006《计算机软件文档编制规范》  
- Flask 官方文档、SQLAlchemy 文档、Vue 3 官方文档  
- ArtPlayer 播放器及 Danmaku 插件官方文档

---

## 2. 任务概述

### 2.1 总体目标

构建一个面向校园场景的**在线视频分享与互动平台**，实现从“视频投稿—管理员审核—用户浏览—互动反馈（点赞、收藏、评论、弹幕）—作者运营（关注、粉丝、个人主页）”的完整闭环流程，满足课程设计对前后端分离、数据库设计、权限控制和文档编制的综合要求。

### 2.2 功能概述

结合现有代码结构，系统主要实现以下功能模块：

- **用户与权限**
  - 用户注册、登录（用户名/学号 + 密码，密码加密存储）  
  - 用户状态控制：正常 / 封禁，被封禁用户无法登录、其视频在前台不可见  
  - 角色管理：普通用户 `user` 与管理员 `admin`（免审上传、后台管理）

- **视频管理**
  - 视频上传：上传视频文件与封面图片，支持前端利用 Canvas 从视频中截帧生成封面  
  - 视频分类：后台维护 `Category`，前端上传页下拉选择分类  
  - 视频审核：普通用户视频先审后发，管理员可查看待审核队列并通过 / 驳回  
  - 视频播放：首页视频瀑布流展示，详情页集成 ArtPlayer 播放器 + 弹幕  
  - 后台管理：管理员可搜索、筛选、删除任意视频

- **互动功能**
  - 点赞：单用户对单视频仅能点赞一次，可取消，实时更新点赞数  
  - 收藏：收藏 / 取消收藏，个人中心展示“我的收藏”  
  - 评论：多级盖楼评论（一级评论 + 回复树），支持时间排序展示  
  - 弹幕：视频播放时加载弹幕列表，用户可发送弹幕，符合 ArtPlayer 数据格式

- **社交与个人中心**
  - 关注 / 取关：用户之间可相互关注，形成关注列表和粉丝列表  
  - 个人主页：展示我的资料、我的投稿、我的收藏、我的关注、我的粉丝，并支持修改头像 / 昵称 / 密码  
  - 作者主页：展示某个作者的公开信息及其已发布视频列表

- **消息与后台运营**
  - 通知中心：包括系统公告、审核结果通知等，支持未读标记、全部已读、详情跳转  
  - 管理后台仪表盘：展示待审核视频数、总用户数、最近 7 天新增用户 / 视频趋势图  
  - 管理员用户管理：分页查看用户列表、搜索用户、封禁 / 解封用户

### 2.3 条件与限制

- 运行环境：  
  - 后端：Python 3.14 + Flask + SQLAlchemy + MySQL（由 `univideo_db.sql` 创建表）  
  - 前端：Vue 3 + Vite，浏览器需支持 HTML5 视频与 Canvas  
- 存储限制：视频、封面、头像均存于后端 `static/` 目录，受服务器磁盘空间限制  
- 安全限制：未引入复杂的 Token/JWT 体系，认证简化为前端存储 `user_id` 并通过请求头或参数传递，适合作为课程设计级别系统。

---

## 3. 总体设计

### 3.1 系统总体结构

系统采用**前后端分离 + RESTful API** 的三层结构模型：

- **表示层（前端 Web）**：  
  - 基于 Vue 3 的单页应用（SPA），主入口为 `src/main.js` 与 `App.vue`  
  - 路由层 `src/router/index.js` 定义首页、登录注册、上传、个人中心、作者页、消息中心及后台路由  
  - 各业务页面使用单文件组件 SFC 实现（如 `Home.vue`、`VideoDetail.vue`、`Upload.vue`、`Profile.vue`、`AdminDashboard.vue`、`AdminAudit.vue`、`MessageCenter.vue`）

- **业务逻辑层（后端 Flask）**：  
  - 应用入口 `backend/app.py` 使用应用工厂 `create_app` 创建 Flask 实例，加载配置，初始化数据库和 CORS  
  - 按业务划分为多个蓝图模块：  
    - `routes/auth.py`：认证模块（注册、登录、获取当前用户）  
    - `routes/video.py`：视频模块（分类、上传、列表、详情、浏览量统计）  
    - `routes/admin.py`：管理员模块（统计、审核、视频管理、用户管理、通知管理）  
    - `routes/interaction.py`：互动模块（评论、点赞、收藏、弹幕、关注/取关、粉丝与关注列表）  
    - `routes/user.py`：用户中心模块（个人资料、我的投稿、我的收藏、作者主页、用户搜索）

- **数据访问层（数据库与模型）**：  
  - `models.py` 中基于 SQLAlchemy 定义所有核心模型：`User`、`Category`、`Video`、`Comment`、`Like`、`Collection`、`Danmaku`、`Follow`、`Notification`  
  - 表结构与 `univideo_db.sql` 严格对应，并通过索引、唯一约束、外键约束保障一致性与性能。

### 3.2 模块划分与外部设计

#### 3.2.1 后端模块划分

- **应用与配置模块**
  - `app.py`：负责应用初始化、蓝图注册、静态文件根路径 `/static` 映射、健康检查接口 `/api/health`。  
  - `config.py`：负责数据库连接、上传目录 `UPLOAD_FOLDER`、允许的视频 / 图片扩展名等配置。  
  - `init_db.py`：用于初始化数据库和表结构（开发/部署辅助）。

- **认证模块 `routes/auth.py`**
  - `/api/auth/register`：用户注册  
  - `/api/auth/login`：用户登录，返回基础用户信息（id、username、nickname、role、avatar）  
  - `/api/auth/me`：根据请求头 `X-User-Id` 获取当前用户信息

- **视频模块 `routes/video.py`**
  - `/api/videos/categories`：获取分类列表（上传页使用）  
  - `/api/videos/upload`：视频上传（表单 + 文件），内部负责校验文件类型、保存到 `static/videos/` 和 `static/covers/`，并根据用户角色设置 `status`（管理员直接发布，普通用户待审核）  
  - `/api/videos/list`：首页视频列表，支持按标题关键词和分类筛选，仅返回已发布且作者状态正常的视频  
  - `/api/videos/<id>`：视频详情页接口，返回播放地址、封面地址、作者信息、分类信息，并在每次访问时自增播放量

- **管理员模块 `routes/admin.py`**
  - 管理员鉴权装饰器 `@admin_required`：从头部 `X-User-ID` 获取用户并验证其为管理员  
  - `/api/admin/stats`：获取待审核视频数、总用户数、今日新增视频数（Admin Dashboard 使用）  
  - `/api/admin/stats/trend`：获取最近 7 天新增用户数、新增视频数量趋势，用于 ECharts 图表  
  - `/api/admin/manage/list`：视频管理列表搜索与按状态筛选  
  - `/api/admin/audit/list`：兼容型接口，返回所有待审核视频列表  
  - `/api/admin/audit/<video_id>`：审核接口（通过 / 驳回），同时生成对应的审核通知 `Notification`  
  - `/api/admin/manage/video/<video_id>`：删除视频（同时尝试删除物理文件）  
  - `/api/admin/notifications/send`：管理员发送通知（系统公告 / 单用户通知）  
  - `/api/admin/notifications`：按用户、已读状态分页获取通知列表  
  - `/api/admin/notifications/<id>/read`：单条标记已读  
  - `/api/admin/notifications/read-all`：批量标记全部已读  
  - `/api/admin/notifications/unread-count`：获取未读通知数量  
  - `/api/admin/users`：分页用户列表，支持用户名/昵称模糊搜索  
  - `/api/admin/users/<id>/status`：更新用户状态（封禁 / 解封），禁止封禁管理员账号

- **互动模块 `routes/interaction.py`**
  - 评论：  
    - `POST /api/videos/<id>/comments`，`GET /api/videos/<id>/comments`  
  - 点赞 / 收藏：  
    - `POST /api/videos/<id>/like`，`GET /api/videos/<id>/like/status`，`POST /api/videos/<id>/collect`，`GET /api/videos/<id>/collect/status`  
  - 弹幕：  
    - `GET/POST /api/videos/<id>/danmaku`  
  - 关注：  
    - `POST /api/follow/<user_id>`，`POST /api/unfollow/<user_id>`，`GET /api/users/<user_id>/followers`，`GET /api/users/<user_id>/following`，`GET /api/users/<user_id>/follow_status`

- **用户中心模块 `routes/user.py`**
  - `/api/users/me` `GET`：根据 `user_id` 查询当前用户信息  
  - `/api/users/me` `PUT`：修改当前用户资料（昵称、密码、头像上传），头像存储在 `static/avatars/`  
  - `/api/users/me/videos`：获取当前用户发布的全部视频（包括待审核、已发布、已驳回），用于“我的投稿”  
  - `/api/users/me/collections`：获取当前用户收藏的已发布视频，用于“我的收藏”  
  - `/api/users/<user_id>`：作者主页接口，返回用户信息及其已发布视频列表  
  - `/api/users/search`：按用户名 / 昵称模糊搜索正常用户，供首页搜索用户与个人中心使用

#### 3.2.2 前端页面与组件

- **公共组件**
  - `NavBar.vue`：全局导航栏，支持搜索关键字、分类筛选及登录状态展示，通过自定义事件向页面派发 `navbar-search` 与 `navbar-category-change`  
  - `ImageCropperModal.vue`：通用图片裁剪组件，上传头像和封面时使用（基于 Canvas 截图/裁剪）

- **主要页面视图（部分示例）**
  - `Home.vue`：首页视频瀑布流 + 搜索结果多态展示（可在“视频 / 用户”两个维度切换），调用 `/videos/list` 与 `/users/search`  
  - `VideoDetail.vue`：视频详情和播放页，集成 ArtPlayer + Danmaku 插件，提供点赞、收藏、关注、评论、多级回复、推荐视频等功能  
  - `Upload.vue`：视频上传与封面截取页，通过 Canvas 抓取视频当前帧，或调用 `ImageCropperModal` 对上传图片进行裁剪，再调用 `/videos/upload`  
  - `Profile.vue`：个人中心，“我的投稿 / 我的收藏 / 我的关注 / 我的粉丝”四个 Tab，支持修改资料、头像上传、对粉丝或关注列表中的用户进行二次关注/取消关注  
  - `AuthorPage.vue`：作者主页，展示作者基础信息及其已发布视频  
  - `MessageCenter.vue`：消息中心，对 `Notification` 进行分类展示（系统公告、审核通知、未读），支持展开/收起长内容、全部已读、关联链接跳转  
  - `AdminLayout.vue` + `AdminDashboard.vue` + `AdminAudit.vue` + `AdminUsers.vue`：管理员后台布局、仪表盘、视频审核管理、用户管理。

### 3.3 功能分配

下表概述功能点与主要程序模块的对应关系（仅列关键项）：

- **用户注册/登录**：`routes/auth.py` + 前端 `Login.vue`、`Register.vue`  
- **视频上传 + 先审后发**：`routes/video.py` 中 `/upload` 接口 + 前端 `Upload.vue`（表单 + 文件上传 + Canvas 截帧）  
- **视频列表 / 搜索 / 分类**：`routes/video.py` `/list` + `Home.vue`  
- **视频详情 + 播放 + 弹幕**：`routes/video.py` `<id>` + `routes/interaction.py` 弹幕接口 + `VideoDetail.vue`  
- **评论 / 回复**：`routes/interaction.py` 评论接口 + `VideoDetail.vue` 评论区  
- **点赞 / 收藏**：`routes/interaction.py` 点赞与收藏接口 + `Home.vue`/`VideoDetail.vue` 图标及个人中心统计  
- **关注 / 粉丝 / 关注列表**：`routes/interaction.py` 关注相关接口 + `Profile.vue`、`AuthorPage.vue`  
- **个人资料修改与头像上传**：`routes/user.py` `/me` PUT + `Profile.vue` + `ImageCropperModal.vue`  
- **管理员审核与视频管理**：`routes/admin.py` 审核、列表、删除接口 + `AdminAudit.vue`  
- **统计报表**：`routes/admin.py` `/stats`、`/stats/trend` + `AdminDashboard.vue`（ECharts 图表）  
- **消息中心**：`routes/admin.py` 通知相关接口 + `MessageCenter.vue`。

---

## 4. 接口设计

本节从“外部接口”（面向前端和用户）和“内部接口”（模块与模块之间的调用约定）两个层面进行说明。  
详细字段含义可结合代码注释与 `univideo_db.sql` 理解，这里给出设计层面的概括。

### 4.1 外部接口（REST API）

#### 4.1.1 通用约定

- 所有接口统一前缀为 `/api`，返回 JSON：  
  - 正常业务接口：`{ code, msg, data }`  
  - 弹幕接口：兼容 ArtPlayer，成功时 `code=0, data=[...]`  
- 认证方式简化为：  
  - 前端登录成功后将 `user_id` 和 `role` 存入 `localStorage`  
  - 后续请求通过：  
    - 请求头 `X-User-ID`（管理员后台、部分需要权限的操作）  
    - 或查询参数 / 请求体的 `user_id` 字段 进行身份透传。

#### 4.1.2 核心接口分组示例

- **认证接口**（`/api/auth/...`）
  - `POST /register`：`{ username, password, nickname }` → 创建新用户  
  - `POST /login`：`{ username, password }` → 返回 `{ id, username, nickname, role, avatar }`  
  - `GET /me`：从头 `X-User-Id` 取当前用户 ID → 返回 `User.to_dict()`

- **视频接口**（`/api/videos/...`）
  - `GET /categories`：返回全量分类列表  
  - `POST /upload`：`multipart/form-data` 含 `user_id`, `title`, `description`, `category_id`, `video_file`, `cover_file`  
  - `GET /list`：支持 `keyword`, `category_id` 过滤，仅返回 `status=1` 且作者正常的视频  
  - `GET /<id>`：返回单个视频详情，并将播放量 `view_count` +1

- **互动接口**（`/api/...`）
  - 评论： `POST /videos/<id>/comments`，`GET /videos/<id>/comments`  
  - 点赞 / 收藏：`POST /videos/<id>/like`，`GET /videos/<id>/like/status`，`POST /videos/<id>/collect`，`GET /videos/<id>/collect/status`  
  - 弹幕：`GET/POST /videos/<id>/danmaku`  
  - 关注：`POST /follow/<user_id>`，`POST /unfollow/<user_id>`，`GET /users/<user_id>/followers`，`GET /users/<user_id>/following`，`GET /users/<user_id>/follow_status`

- **用户接口**（`/api/users/...`）
  - `GET /me`：`user_id` 查询参数  
  - `PUT /me`：`FormData` 形式提交 `user_id`, `nickname`, `password?`, `avatar?`  
  - `GET /me/videos`，`GET /me/collections`  
  - `GET /<user_id>`：作者主页数据  
  - `GET /search`：按关键字搜索用户

- **管理员接口**（`/api/admin/...`）
  - `GET /stats`，`GET /stats/trend`：统计与趋势  
  - `GET /manage/list`：视频管理列表（关键词 + 状态筛选）  
  - `GET /audit/list`，`POST /audit/<video_id>`：审核队列与审核操作  
  - `DELETE /manage/video/<video_id>`：删除视频  
  - 通知：`POST /notifications/send`，`GET /notifications`，`PUT /notifications/<id>/read`，`PUT /notifications/read-all`，`GET /notifications/unread-count`  
  - 用户管理：`GET /users`（分页 + 搜索）、`POST /users/<id>/status` 更新用户状态。

### 4.2 内部接口（模块间调用与约定）

- **应用与模型之间**
  - `app.py` 中通过 `db.init_app(app)` 初始化数据库，在各蓝图中通过 `from models import db, User, Video, ...` 引入模型并使用 `db.session` 进行事务管理。

- **蓝图与模型之间**
  - 所有业务蓝图不直接拼接 SQL 语句，而是使用 SQLAlchemy ORM 的查询 API（如 `User.query.filter_by(...)`、`Video.query.join(User)...` 等）访问数据库，提高可维护性与安全性。  
  - 各蓝图通过调用模型上的业务方法（如 `User.set_password()`、`User.is_admin()`、`Video.get_likes_count()`、`User.follow()` 等）来封装常用逻辑。

- **蓝图之间**
  - 蓝图之间不直接互相调用函数，而是通过共享的模型和数据库层进行协作，例如：  
    - 审核模块在审核通过 / 驳回视频时，通过 `Notification` 模型创建一条通知记录，后续由 `MessageCenter.vue` 通过通知接口进行展示。  
    - 互动模块在点赞/收藏后，通过 `Video` 模型的关系属性间接影响个人中心列表的查询结果。

---

## 5. 数据结构设计

本系统的核心数据结构由 `models.py` 中的 ORM 模型定义，并在 `univideo_db.sql` 中有对应的物理表结构。下文只给出关键字段与关系设计说明。

### 5.1 用户相关

- **User（users 表）**
  - `id`：主键，自增  
  - `username`：学号 / 登录名，唯一索引  
  - `password`：加密后的密码（使用 `werkzeug.security`）  
  - `nickname`：昵称  
  - `role`：`user` 或 `admin`  
  - `avatar`：头像相对路径 `avatars/...`  
  - `status`：用户状态（1 正常，0 封禁）  
  - 关系：
    - `videos`：一对多，用户上传的视频  
    - `comments`、`likes`、`collections`、`danmakus`：与评论、点赞、收藏、弹幕的逻辑关联  
    - `followed` / `followers`：通过 `Follow` 表实现的关注与粉丝关系  
    - `favorites`：通过 `collections` 关联表形成的收藏视频集合

- **Follow（follows 表）**
  - 复合主键：`follower_id` + `followed_id`  
  - `timestamp`：关注时间  
  - 索引：按 `follower_id` 与 `followed_id` 分别建立索引，以优化“我的关注 / 粉丝列表”查询  
  - 约束：`CheckConstraint(follower_id != followed_id`，防止自关注）。

### 5.2 视频与分类

- **Category（categories 表）**
  - `id`、`name`，其中 `name` 唯一，确保分类唯一性。

- **Video（videos 表）**
  - `id`、`title`、`description`  
  - 文件路径：`cover_path`、`video_path`（相对 `static`）  
  - `status`：0 待审核、1 已发布、2 已驳回  
  - `view_count`：浏览量  
  - `created_at`：上传时间  
  - 外键：`user_id`（作者，级联删除）、`category_id`（分类）  
  - 关系：`comments`、`likes`、`collections`、`danmakus`、`notifications`  
  - 方法：`get_likes_count()`、`get_collections_count()`、`to_dict(include_author=True/False)`。

### 5.3 互动数据结构

- **Comment（comments 表）**
  - `id`、`content`、`created_at`  
  - 外键：`user_id`、`video_id`  
  - 自关联：`parent_id`（父评论）、`root_id`（整个楼层的根评论），并通过索引 `idx_video_root(video_id, root_id)` 优化查询  
  - 关系：`parent`、`children`、`root`、`all_replies`，用于构建树形结构。

- **Like（likes 表）**
  - `id`、`user_id`、`video_id`、`created_at`  
  - 唯一约束：`(user_id, video_id)`，防止重复点赞。

- **Collection（collections 表）**
  - 结构类似于 Like，用于收藏关系；同样对 `(user_id, video_id)` 建立唯一约束。

- **Danmaku（danmaku 表）**
  - `id`、`text`、`time`（秒）、`color`、`mode`、`border`、`created_at`  
  - 外键：`user_id`、`video_id`  
  - 索引：`idx_video_time(video_id, time)`，优化按时间顺序拉取弹幕。

### 5.4 通知数据结构

- **Notification（notifications 表）**
  - `id`、`title`、`content`  
  - `msg_type`：`system`（系统公告）、`audit`（审核通知）、`interaction`（预留）  
  - `related_link`：关联跳转链接（如 `/video/<id>` 或 `/upload`）  
  - `is_read`：是否已读  
  - `created_at`：创建时间  
  - `extra_data`：JSON 字符串，存储额外信息（例如审核驳回理由）  
  - 外键：`user_id`（接收者，NULL 表示全体系统公告）、`video_id`（可选）  
  - 索引：`idx_user_created(user_id, created_at)`、`idx_is_read(is_read)`。

---

## 6. 逻辑结构设计

本节从典型业务流程角度描述主要逻辑。

### 6.1 用户注册与登录流程

- **注册**  
  1. 前端 `Register.vue` 收集用户名、密码、昵称，并进行基本校验（长度等）  
  2. 发送 `POST /api/auth/register`  
  3. 后端验证字段完整性、用户名唯一性、密码长度后，调用 `User.set_password` 进行密码哈希，插入数据库  
  4. 返回成功信息与新用户的基本资料。

- **登录**  
  1. 前端 `Login.vue` 提交用户名和密码到 `POST /api/auth/login`  
  2. 后端查找用户，验证密码哈希，并检查 `status` 是否为 1  
  3. 若用户被封禁，则返回 403 与封禁提示  
  4. 登录成功后，前端将 `user_id`, `role`, `nickname` 等信息写入 `localStorage`，用于后续请求与路由守卫。

### 6.2 视频上传与审核发布流程

- **上传流程**（`Upload.vue` + `/api/videos/upload`）
  1. 用户选择视频文件，前端生成 `videoPreviewUrl` 并通过 `<video>` 元素播放  
  2. 用户可从视频当前帧利用 Canvas 截取封面，或上传自定义封面并通过 `ImageCropperModal` 裁剪为 16:9 比例  
  3. 提交表单时，前端构造 `FormData`，包含 `user_id`, `title`, `description`, `category_id`, `video_file`, `cover_file`  
  4. 后端校验必填字段、文件存在性和格式合法性，将文件保存至 `UPLOAD_FOLDER/videos` 和 `UPLOAD_FOLDER/covers`，在数据库中记录相对路径  
  5. 根据用户角色设置 `Video.status`：管理员上传直接 `STATUS_PUBLISHED`，普通用户为 `STATUS_PENDING`，并返回不同提示语。

- **审核流程**（`AdminAudit.vue` + `/api/admin/audit/...`）
  1. 管理员登录后台后，`AdminAudit.vue` 调用 `/api/admin/manage/list` 显示待处理视频  
  2. 点击“审核”进入审核弹窗，通过 ArtPlayer 预览视频，查看标题、简介、作者、分类等信息  
  3. 管理员点击“通过”或“驳回”：  
     - 通过：将 `status` 置为已发布，并创建一条“审核通过”的 `Notification`，`related_link` 指向 `/video/<id>`  
     - 驳回：将 `status` 置为已驳回，并记录驳回理由到 `extra_data` 与 `content` 中，`related_link` 通常指向 `/upload` 引导重传  
  4. 审核完成后自动切换到下一个待审核视频，提升审核效率。

### 6.3 首页浏览与检索逻辑

- 首页 `Home.vue`：  
  1. 通过 NavBar 派发的事件或路由参数获得 `keyword` 与 `category_id`，调用 `/api/videos/list` 获取视频列表  
  2. 同时调用 `/api/users/search` 获取匹配的用户列表，支持在“视频 / 用户”两种结果视图间切换  
  3. 前端对播放量 `view_count` 进行格式化展示（如“1.2万”、“3.4千”），视频卡片点击后跳转详情页。

### 6.4 点赞 / 收藏 / 评论 / 弹幕逻辑

- **点赞 / 收藏**  
  - 在详情页 `VideoDetail.vue` 中，进入时先调用 `GET /like/status` 和 `GET /collect/status` 获取当前用户对该视频的状态  
  - 用户点击按钮后调用 `POST /like` 或 `POST /collect`，后端根据是否已有记录进行“开关式”切换，并返回最新计数，前端据此更新 UI。

- **评论 / 盖楼回复**  
  - 发表评论时（无 `parent_id`）：`root_id` 为 `NULL`，即一级评论  
  - 对某条评论回复时：  
    - 若父评论为一级评论，则子评论的 `root_id` 设为父评论的 `id`  
    - 若父评论本身已有 `root_id`，则沿用其 `root_id`，保证同一楼层的评论归属一致  
  - 前端获取 `/comments` 后以 `root_id` 将评论分组并渲染为树结构，分别在一级评论下展示其回复列表。

- **弹幕逻辑**  
  - `VideoDetail.vue` 初始化 ArtPlayer 时注入 Danmaku 插件，插件内部会调用 `GET /videos/<id>/danmaku` 拉取弹幕数组  
  - 用户发送弹幕时调用 `POST /videos/<id>/danmaku`，后端校验文本长度与用户、视频存在性，然后插入 `Danmaku` 表。

### 6.5 关注与个人中心逻辑

- 关注 / 取关通过 `Follow` 表的插入 / 删除实现，并在 `User` 模型中封装了 `follow()`、`unfollow()`、`is_following()` 方法。  
- 个人中心 `Profile.vue` 在挂载时并行调用：  
  - `/api/users/me` 获取个人资料  
  - `/api/users/me/videos` 获取我的投稿列表（含状态）  
  - `/api/users/me/collections` 获取我的收藏视频  
  - `getFollowing()` 与 `getFollowers()` 获取关注与粉丝列表，并通过 `getFollowStatus()` 构建本地 `followStatusMap`，在列表中动态显示“关注 / 已关注”按钮。

### 6.6 通知与消息中心逻辑

- 管理员通过后台发送通知或触发审核操作时，都会向 `notifications` 表插入一条记录  
- `MessageCenter.vue` 在加载时调用 `/api/admin/notifications`，根据 `msg_type` 和 `title` 进行多态展示：  
  - 系统公告：统一以“系统公告”标识  
  - 审核通知：根据标题包含“驳回”或“通过”渲染不同颜色和图标  
  - 长内容支持“展开 / 收起”按钮，提升可读性  
- 用户点击某条消息时：  
  - 若未读，则调用 `PUT /api/admin/notifications/<id>/read` 标记已读  
  - 如果有 `related_link`，则通过路由跳转到对应页面（如视频详情或上传页）。

---

## 7. 物理结构设计

### 7.1 部署结构

- **服务器端**
  - 操作系统：Windows / macOS / Linux 均可  
  - 后端进程：使用 Flask 自带开发服务器运行（`python backend/app.py`），端口 `5001`，对外暴露静态资源 `/static` 目录  
  - 数据库：MySQL，根据 `univideo_db.sql` 初始化库表  
  - 媒体文件：位于后端 `backend/static/` 目录下的 `videos/`、`covers/`、`avatars/` 子目录。

- **客户端**
  - 使用现代浏览器访问前端 Vue 应用（通过 `npm run dev` 提供的本地开发服务器），默认前端访问后端地址为 `http://localhost:5001/api`。

### 7.2 文件与目录组织

- 后端 `backend/`
  - `app.py`、`config.py`、`models.py`、`routes/*.py`  
  - `static/videos/`：视频文件  
  - `static/covers/`：视频封面  
  - `static/avatars/`：用户头像

- 前端 `frontend/`
  - `src/main.js`、`src/App.vue`、`src/router/index.js`  
  - `src/api.js`：封装 Axios 实例与部分关注相关 API  
  - `src/views/`：各业务页面组件  
  - `src/components/`：通用组件（NavBar、ImageCropperModal 等）。

---

## 8. 数据结构与程序的关系

- **ORM 模型与数据库表**  
  - `models.py` 中的每个类与 `univideo_db.sql` 中的一张表一一对应，通过 `__tablename__` 指定表名，对应字段通过 `db.Column` 映射具体类型与约束。  
  - 关系属性（如 `User.videos`, `Video.comments`, `User.favorites`）通过 SQLAlchemy 的关系映射生成，便于在业务代码中直接访问关联对象而不必手写 JOIN 语句。

- **API 层与模型层**  
  - 各路由模块仅关心业务场景，将输入参数校验后，调用模型提供的方法进行增删改查，并通过模型的 `to_dict()` 方法组装返回结构，确保前端与后端之间的耦合度较低。  
  - 例如视频列表接口 `get_video_list()` 中，通过 `Video.query.join(User)` 并过滤 `User.status` 和 `Video.status`，在返回时补充完整的 `cover_url` 和 `video_url` 字段。

- **前端组件与数据结构**  
  - 前端在接收后端返回的 JSON 时，基本保持数据结构不变，仅做展示层的轻量加工（如播放量格式化、时间本地化显示、树状评论构造）。  
  - 评论树 `commentTree` 通过对 `root_id` 分组生成；消息中心通过 `msg_type` 和 `title` 进行 UI 风格选择。

---

## 9. 运行设计

### 9.1 运行模块的组合

- **后端启动模块**
  - 入口：`backend/app.py`，在 `if __name__ == '__main__':` 中启动 Flask 应用，监听 `0.0.0.0:5001`  
  - 依赖：`config.py` 提供数据库与上传目录配置，`models.py` 提供 ORM 定义，`routes` 目录提供蓝图。

- **前端启动模块**
  - 使用 `npm install` 安装依赖后，通过 `npm run dev` 启动开发服务器，默认在 `http://localhost:5173` 端口  
  - 由 `main.js` 创建 Vue 应用实例并挂载路由与全局样式。

### 9.2 运行控制

- **权限控制**
  - 路由守卫：  
    - 访问需要登录的页面（上传、个人中心、消息中心、后台路由）前，`router.beforeEach` 会检查 `localStorage` 中的 `user_id` 是否存在  
    - 访问后台路由（`/admin/...`）时额外验证 `role === 'admin'`，否则重定向到首页  
  - 后端鉴权：  
    - 管理员接口统一通过 `admin_required` 装饰器校验 `X-User-ID` 对应用户是否为管理员  
    - 普通接口通过校验 `user_id` 与对象存在性来防止非法操作（如点赞、收藏、关注时用户或视频不存在）。

- **事务控制**
  - 所有涉及写操作（注册、上传、评论、点赞、收藏、弹幕、关注、审核、删除等）的接口均在出现异常时调用 `db.session.rollback()` 以保证数据一致性。

### 9.3 运行时间与性能

- 系统适用于小规模校园内部使用，主要性能瓶颈在视频文件传输及数据库查询上：  
  - 通过必要的索引（如 `idx_video_root`、`idx_user_created`、唯一约束等）提高查询效率  
  - 通过前端异步加载和分页（通知、关注列表等）避免一次性获取过多数据。

---

## 10. 出错处理设计

### 10.1 出错输出信息

- 统一采用 JSON 结构返回错误：`{ code, msg }`，HTTP 状态码与业务 `code` 一致或相近，例如：  
  - 400：参数缺失或非法（`msg` 明确指出缺少的字段或错误的取值）  
  - 401：未登录或用户不存在  
  - 403：权限不足或账号被封禁  
  - 404：请求资源不存在（用户 / 视频 / 评论等）  
  - 409：用户名冲突等并发冲突  
  - 500：服务器内部错误（`msg` 中包含异常信息，便于调试）。

### 10.2 出错处理策略

- **后端**  
  - 对所有写操作接口使用 `try/except` 包裹，在 `except` 中回滚事务并返回统一的 500 错误 JSON  
  - 文件删除失败时不影响数据库记录删除，但会在服务器控制台打印日志，避免影响主要业务。

- **前端**  
  - 所有 Axios 调用均通过 `try/catch` 捕获错误，在 `catch` 中优先显示后端返回的 `msg`，若无则显示通用错误提示  
  - 在关键操作（删除视频、审核通过/驳回）前使用 `window.confirm` 进行二次确认，避免误操作。

---

## 11. 安全保密设计

- **身份与权限**
  - 用户密码采用不可逆哈希存储，避免明文泄露  
  - 严格区分普通用户与管理员角色，管理员接口必须通过 `admin_required` 校验  
  - 登录态仅在前端以 `user_id` 和 `role` 的形式存储，适用于教学与课程设计场景。

- **数据安全**
  - 通过用户状态 `status` 控制封禁账号，不允许封禁管理员账号  
  - 视频查询逻辑中明确排除被封禁用户的内容，防止违规用户的视频继续在前台展示  
  - 审核机制确保普通用户上传内容在通过前不会在首页和详情页对所有人公开。

- **接口安全**
  - 所有写操作接口都进行参数校验与存在性校验，防止越权操作（如对不存在的视频点赞、收藏或评论）  
  - 通过合理的错误码和信息提示引导前端处理，不返回敏感的系统内部信息。

---

## 12. 维护设计

- **代码组织与注释**
  - 后端按照“模型 / 路由 / 配置”分层组织，所有接口函数和模型方法均配有中文 docstring 说明，便于 AI 和后续开发者快速理解  
  - 前端组件内部通过结构化注释（“数据定义 / 工具函数 / API 调用 / 生命周期”等）梳理逻辑。

- **可扩展性**
  - 通过 SQLAlchemy ORM 和 Vue 组件化设计，方便后续增加新功能（如更丰富的分类、举报与申诉、弹幕屏蔽、推荐算法等）  
  - 通知模型 `Notification` 预留了 `interaction` 类型与 `extra_data` 字段，可扩展点赞 / 评论提醒等。

- **配置与部署**
  - 关键路径与配置集中在 `config.py` 中，便于切换数据库地址、上传目录等运行环境参数  
  - 静态资源路径统一通过后端拼接完整 URL（`http://localhost:5001/static/...`），前端只需展示，不需关心服务器目录结构。

- **文档维护**
  - 本说明书随着代码实现同步维护，新增模块或接口时应同时更新对应章节（特别是第 3、4、5、6 章），以保持设计文档与实现的一致性。