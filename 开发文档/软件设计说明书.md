# 软件设计说明书

**目录**
(请保留原Word模板中的自动目录)

---

## 1. 引言

### 1.1 编写目的

本文档详细描述了 **UniVideo（校园视界）** 系统的软件设计，包括系统架构、模块设计、数据库设计、接口设计等。其编写目的是为了明确系统"怎么做"，为后续的编码实现、测试验收提供统一的设计标准和依据。

预期的读者包括：

* 项目开发人员（李梓豪）
* 软件测试人员
* 软件工程课程设计指导教师

### 1.2 背景

* **a. 待开发的软件系统的名称：** UniVideo 校园视界（校园视频分享平台）
* **b. 本项目的任务提出者：** 软件工程课程设计指导教师
* **开发者：** 软件工程234班 李梓豪 (学号: 2318140407)
* **用户：** 大连交通大学全校师生、系统管理员

* **c. 该软件系统同其他系统或其他机构的基本的相互来往关系：** 本系统独立运行，不依赖外部第三方账号体系。系统运行于校园局域网或互联网环境，通过 HTTP 协议与客户端浏览器进行数据交互。

### 1.3 定义

* **B/S 架构（Browser/Server）：** 浏览器/服务器架构，客户端通过浏览器访问服务器提供的 Web 服务。
* **RESTful API：** 符合 REST 架构风格的 Web API 设计规范，使用标准 HTTP 方法（GET、POST、PUT、DELETE）进行操作。
* **ORM（Object-Relational Mapping）：** 对象关系映射，将数据库表映射为程序中的对象，简化数据库操作。
* **Blueprint（蓝图）：** Flask 框架中的模块化组织方式，用于将路由分组管理。
* **Composition API：** Vue 3 提供的组合式 API，用于组织组件逻辑。
* **Pre-audit（先审后发）：** 指视频上传后默认状态不可见，必须经管理员后台审核通过后，方可在前台展示的机制。
* **Nested Comment（嵌套评论）：** 指评论区支持对已有评论进行回复，形成树状结构的交流形式。

### 1.4 参考资料

* **a.** 《软件工程课程设计指导书》，大连交通大学软件工程教研室，2025。
* **b.** UniVideo 系统《可行性分析与开发计划》。
* **c.** UniVideo 系统《需求分析规格说明书》。
* **d.** GB/T 8567-2006 《计算机软件文档编制规范》。
* **e.** Flask 2.0 官方文档、Vue.js 3.0 官方文档、SQLAlchemy 官方文档。

---

## 2. 系统总体设计

### 2.1 系统架构

UniVideo 系统采用前后端分离的 B/S 架构，整体架构如下：

```
┌─────────────────┐
│   客户端浏览器   │
│   (Vue 3 前端)   │
└────────┬────────┘
         │ HTTP/JSON
         │
┌────────▼────────┐
│  Flask 后端服务  │
│  (RESTful API)  │
└────────┬────────┘
         │
┌────────▼────────┐
│   MySQL 数据库   │
└─────────────────┘
         │
┌────────▼────────┐
│   本地文件系统   │
│  (视频/图片存储) │
└─────────────────┘
```

**架构特点：**
* **前后端分离：** 前端与后端通过 RESTful API 进行通信，完全解耦。
* **分层设计：** 表现层（前端）、业务逻辑层（后端路由）、数据访问层（ORM）。
* **模块化：** 后端采用 Flask Blueprint 进行模块划分，前端采用 Vue 组件化开发。

### 2.2 技术选型

#### 2.2.1 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.8+ | 开发语言 |
| Flask | 2.3+ | Web 框架 |
| SQLAlchemy | 2.0+ | ORM 框架 |
| Flask-Migrate | 4.0+ | 数据库迁移工具 |
| Flask-CORS | 4.0+ | 跨域支持 |
| PyMySQL | 1.1+ | MySQL 数据库驱动 |
| Werkzeug | 2.3+ | 密码加密工具 |

#### 2.2.2 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue.js | 3.5+ | 前端框架 |
| Vue Router | 4.6+ | 路由管理 |
| Axios | 1.13+ | HTTP 客户端 |
| Vite | 7.3+ | 构建工具 |
| ArtPlayer | 5.3+ | 视频播放器 |

#### 2.2.3 数据库

| 技术 | 版本 | 用途 |
|------|------|------|
| MySQL | 8.0+ | 关系型数据库 |

### 2.3 系统模块划分

系统主要划分为以下模块：

#### 2.3.1 后端模块

1. **认证模块（auth）**
   * 用户注册
   * 用户登录
   * 用户身份识别

2. **视频模块（video）**
   * 视频上传
   * 视频列表查询
   * 视频详情获取
   * 分类管理

3. **用户模块（user）**
   * 用户信息管理
   * 个人资料修改
   * 我的视频列表
   * 我的收藏列表

4. **管理员模块（admin）**
   * 视频审核
   * 视频管理
   * 视频删除

5. **互动模块（interaction）**
   * 评论管理
   * 点赞功能
   * 收藏功能

#### 2.3.2 前端模块

1. **首页模块（Home）**
   * 视频列表展示
   * 搜索功能
   * 分类筛选

2. **认证模块（Login/Register）**
   * 用户登录
   * 用户注册

3. **视频详情模块（VideoDetail）**
   * 视频播放
   * 评论展示与发表
   * 点赞收藏

4. **上传模块（Upload）**
   * 视频文件上传
   * 封面图片上传
   * 视频信息填写

5. **个人中心模块（Profile）**
   * 资料修改
   * 我的视频
   * 我的收藏

6. **管理后台模块（AdminAudit）**
   * 待审核列表
   * 审核操作

### 2.4 项目目录结构

```
UniVideo/
├── backend/                    # 后端 Flask 应用
│   ├── app.py                 # 应用入口：创建Flask实例，注册蓝图
│   ├── config.py              # 配置文件：开发/测试/生产环境配置
│   ├── models.py              # 数据库模型：User, Video, Comment等
│   ├── init_db.py             # 数据库初始化脚本
│   ├── requirements.txt       # Python依赖包列表
│   ├── routes/                # 路由模块（蓝图）
│   │   ├── __init__.py        # 路由模块初始化
│   │   ├── auth.py            # 认证路由：注册、登录
│   │   ├── video.py           # 视频路由：上传、列表、详情
│   │   ├── user.py            # 用户路由：个人中心、资料修改
│   │   ├── admin.py           # 管理员路由：审核、管理
│   │   └── interaction.py     # 互动路由：评论、点赞、收藏
│   └── static/                # 静态文件存储
│       ├── videos/            # 视频文件
│       ├── covers/            # 封面图片
│       └── avatars/           # 用户头像
│
└── frontend/                   # 前端 Vue 应用
    ├── src/
    │   ├── main.js            # 应用入口：创建Vue实例
    │   ├── App.vue            # 根组件：路由视图容器
    │   ├── api.js             # Axios配置：HTTP客户端
    │   ├── assets/            # 静态资源
    │   │   ├── base.css       # 基础样式
    │   │   └── main.css       # 主样式
    │   ├── router/            # 路由配置
    │   │   └── index.js       # 路由定义
    │   └── views/             # 页面组件
    │       ├── Home.vue       # 首页：视频列表
    │       ├── Login.vue      # 登录页
    │       ├── Register.vue   # 注册页
    │       ├── Upload.vue     # 上传页
    │       ├── VideoDetail.vue # 视频详情页
    │       ├── Profile.vue    # 个人中心
    │       ├── AdminAudit.vue # 管理员审核页
    │       └── AuthorPage.vue # 作者主页
    ├── package.json           # 前端依赖配置
    └── vite.config.js         # Vite配置
```

---

## 3. 详细设计

### 3.1 后端详细设计

#### 3.1.1 应用入口设计（app.py）

**设计模式：** 应用工厂模式

**核心函数：** `create_app(config_name='development')`

**功能说明：**
1. 创建 Flask 应用实例
2. 加载配置（开发/测试/生产环境）
3. 初始化扩展：
   * SQLAlchemy 数据库连接
   * Flask-Migrate 数据库迁移
   * Flask-CORS 跨域支持
4. 创建上传目录（videos、covers、avatars）
5. 注册蓝图模块

**蓝图注册：**
```python
# 认证模块
app.register_blueprint(auth_bp, url_prefix='/api/auth')

# 视频模块
app.register_blueprint(video_bp, url_prefix='/api/videos')

# 管理员模块
app.register_blueprint(admin_bp, url_prefix='/api/admin')

# 互动模块
app.register_blueprint(interaction_bp, url_prefix='/api')

# 用户模块
app.register_blueprint(user_bp, url_prefix='/api/users')
```

#### 3.1.2 配置管理设计（config.py）

**配置类层次结构：**
* `Config`（基础配置类）
  * `DevelopmentConfig`（开发环境）
  * `TestingConfig`（测试环境，使用内存数据库）
  * `ProductionConfig`（生产环境）

**关键配置项：**
* `SECRET_KEY`：会话加密密钥
* `UPLOAD_FOLDER`：文件上传目录（绝对路径）
* `MAX_CONTENT_LENGTH`：最大上传大小（500MB）
* `SQLALCHEMY_DATABASE_URI`：MySQL 连接 URI
* `ALLOWED_VIDEO_EXTENSIONS`：允许的视频格式（mp4、avi、mov 等）
* `ALLOWED_IMAGE_EXTENSIONS`：允许的图片格式（jpg、png、gif 等）

#### 3.1.3 数据库模型设计（models.py）

系统共设计 6 个核心数据模型：

**1. User（用户模型）**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| username | String(50) | 学号/用户名，唯一，索引 |
| password | String(255) | 加密后的密码 |
| nickname | String(50) | 用户昵称 |
| role | String(20) | 角色：user/admin，默认 'user' |
| avatar | String(255) | 头像路径 |
| created_at | DateTime | 注册时间 |

**关系：**
* `videos`：用户上传的视频（一对多）
* `comments`：用户发表的评论（一对多）
* `likes`：用户的点赞记录（一对多）
* `collections`：用户的收藏记录（一对多）
* `favorites`：用户收藏的视频（多对多，通过 collections 表）

**方法：**
* `set_password(password)`：加密密码
* `check_password(password)`：验证密码
* `is_admin()`：判断是否为管理员
* `to_dict()`：转换为字典（API 响应）

**2. Category（分类模型）**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| name | String(50) | 分类名称，唯一 |

**关系：**
* `videos`：分类下的视频（一对多）

**3. Video（视频模型）⭐核心**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| title | String(100) | 视频标题 |
| description | Text | 视频简介 |
| cover_path | String(255) | 封面图片路径 |
| video_path | String(255) | 视频文件路径 |
| status | SmallInteger | 状态：0=待审核, 1=已发布, 2=已驳回，索引 |
| view_count | Integer | 播放量，默认 0 |
| created_at | DateTime | 上传时间，索引 |
| user_id | Integer | 外键，关联 users.id，级联删除 |
| category_id | Integer | 外键，关联 categories.id |

**状态常量：**
* `STATUS_PENDING = 0`：待审核
* `STATUS_PUBLISHED = 1`：已发布
* `STATUS_REJECTED = 2`：已驳回

**关系：**
* `author`：视频作者（反向引用）
* `category`：视频分类（反向引用）
* `comments`：视频的评论（一对多）
* `likes`：视频的点赞记录（一对多）
* `collections`：视频的收藏记录（一对多）

**方法：**
* `get_likes_count()`：获取点赞数
* `get_collections_count()`：获取收藏数
* `to_dict(include_author=True)`：转换为字典

**4. Comment（评论模型）- 支持多级评论**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| content | Text | 评论内容 |
| created_at | DateTime | 评论时间 |
| user_id | Integer | 外键，关联 users.id，级联删除 |
| video_id | Integer | 外键，关联 videos.id，级联删除 |
| parent_id | Integer | 外键，关联 comments.id，直接父评论ID |
| root_id | Integer | 外键，关联 comments.id，根评论ID |

**索引：** `idx_video_root` (video_id, root_id) - 优化查询

**关系：**
* `parent`：父评论（自关联）
* `children`：子评论列表（反向引用）
* `root`：根评论（自关联）
* `all_replies`：根评论下的所有回复（反向引用）

**多级评论逻辑：**
* **一级评论：** parent_id=None, root_id=None
* **回复评论：**
  * 如果父评论是一级评论：root_id = parent_id
  * 如果父评论是回复：root_id = 父评论的 root_id

**5. Like（点赞模型）**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| created_at | DateTime | 点赞时间 |
| user_id | Integer | 外键，关联 users.id，级联删除 |
| video_id | Integer | 外键，关联 videos.id，级联删除 |

**约束：** 联合唯一约束 (user_id, video_id) - 防止重复点赞

**6. Collection（收藏模型）**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| created_at | DateTime | 收藏时间 |
| user_id | Integer | 外键，关联 users.id，级联删除 |
| video_id | Integer | 外键，关联 videos.id，级联删除 |

**约束：** 联合唯一约束 (user_id, video_id) - 防止重复收藏

#### 3.1.4 路由模块设计

**1. 认证路由（routes/auth.py）**

| 路由 | 方法 | 功能 | 输入参数 | 输出 |
|------|------|------|----------|------|
| `/register` | POST | 用户注册 | JSON: {username, password, nickname} | 注册成功信息或错误信息 |
| `/login` | POST | 用户登录 | JSON: {username, password} | 用户信息（不含JWT） |
| `/me` | GET | 获取当前用户 | Header: X-User-Id | 用户详细信息 |

**认证机制：**
* 简化版认证：通过请求头 `X-User-Id` 传递用户ID
* 前端在 localStorage 存储用户ID
* 未使用 JWT Token（可后续升级）

**2. 视频路由（routes/video.py）**

| 路由 | 方法 | 功能 | 输入参数 | 输出 |
|------|------|------|----------|------|
| `/categories` | GET | 获取分类列表 | 无 | 分类列表 |
| `/upload` | POST | 上传视频 | FormData: user_id, title, description, category_id, video_file, cover_file | 上传成功信息 |
| `/list` | GET | 获取视频列表 | Query: keyword, category_id | 视频列表（仅已发布） |
| `/<id>` | GET | 获取视频详情 | 路径参数：id | 视频详情（访问时 view_count+1） |

**上传逻辑：**
1. 验证文件格式（视频：mp4/avi/mov 等，封面：jpg/png/gif 等）
2. 生成唯一文件名：`{timestamp}_{uuid}.ext`
3. 保存文件到服务器
4. 根据用户角色设置状态：
   * **管理员：** 直接发布（status=1）
   * **普通用户：** 待审核（status=0）
5. 保存记录到数据库

**3. 用户路由（routes/user.py）**

| 路由 | 方法 | 功能 | 输入参数 | 输出 |
|------|------|------|----------|------|
| `/me` | GET | 获取用户信息 | Query: user_id | 用户详细信息 |
| `/me` | PUT | 更新用户资料 | FormData: user_id, nickname, password, avatar | 更新后的用户信息 |
| `/me/videos` | GET | 获取我的视频 | Query: user_id | 用户上传的所有视频（含各种状态） |
| `/me/collections` | GET | 获取我的收藏 | Query: user_id | 用户收藏的已发布视频 |
| `/<user_id>` | GET | 获取指定用户信息 | 路径参数：user_id | 用户信息和已发布的视频列表 |

**4. 管理员路由（routes/admin.py）**

| 路由 | 方法 | 功能 | 输入参数 | 输出 |
|------|------|------|----------|------|
| `/manage/list` | GET | 获取管理列表 | Query: keyword, status | 视频列表（支持筛选） |
| `/audit/list` | GET | 获取待审核列表 | 无 | 待审核视频列表（按时间升序） |
| `/audit/<video_id>` | POST | 审核视频 | JSON: {action: "approve"\|"reject"} | 审核操作结果 |
| `/manage/video/<video_id>` | DELETE | 删除视频 | 路径参数：video_id | 删除结果 |

**审核逻辑：**
* 仅能审核 status=0（待审核）的视频
* approve → status=1（已发布）
* reject → status=2（已驳回）

**5. 互动路由（routes/interaction.py）**

| 路由 | 方法 | 功能 | 输入参数 | 输出 |
|------|------|------|----------|------|
| `/videos/<video_id>/comments` | POST | 发表评论 | JSON: {user_id, content, parent_id?} | 创建的评论信息 |
| `/videos/<video_id>/comments` | GET | 获取评论列表 | 路径参数：video_id | 评论列表 |
| `/videos/<video_id>/like` | POST | 点赞/取消 | JSON: {user_id} | 当前点赞状态和总数 |
| `/videos/<video_id>/like/status` | GET | 获取点赞状态 | Query: user_id | 是否已点赞 |
| `/videos/<video_id>/collect` | POST | 收藏/取消 | JSON: {user_id} | 当前收藏状态和总数 |
| `/videos/<video_id>/collect/status` | GET | 获取收藏状态 | Query: user_id | 是否已收藏 |

**点赞/收藏逻辑：**
* 如果已存在记录 → 删除记录（取消）
* 如果不存在记录 → 创建记录（添加）

### 3.2 前端详细设计

#### 3.2.1 应用入口设计（main.js）

**功能：**
* 创建 Vue 应用实例
* 注册路由
* 挂载到 DOM

**代码结构：**
```javascript
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'

const app = createApp(App)
app.use(router)
app.mount('#app')
```

#### 3.2.2 路由配置设计（router/index.js）

**路由定义：**

| 路径 | 名称 | 组件 | 说明 |
|------|------|------|------|
| `/` | home | `Home.vue` | 首页：视频列表 |
| `/login` | login | `Login.vue` | 登录页 |
| `/register` | register | `Register.vue` | 注册页 |
| `/upload` | upload | `Upload.vue` | 视频上传页 |
| `/video/:id` | video | `VideoDetail.vue` | 视频详情页 |
| `/profile` | profile | `Profile.vue` | 个人中心 |
| `/admin` | admin | `AdminAudit.vue` | 管理员审核页 |
| `/author/:id` | author | `AuthorPage.vue` | 作者主页 |

**路由模式：** `createWebHistory`（HTML5 History 模式）

#### 3.2.3 API 配置设计（api.js）

**Axios 实例配置：**
* `baseURL`: `http://localhost:5001/api`
* `timeout`: 10000ms
* `headers`: `Content-Type: application/json`

**请求拦截器：**
* 从 `localStorage.getItem('user_id')` 获取用户ID
* 添加到请求头：`X-User-ID: {user_id}`

#### 3.2.4 页面组件设计

**1. Home.vue（首页）**
* 功能：视频列表展示、搜索、分类筛选
* 数据：视频列表、分类列表
* 交互：点击视频卡片跳转详情页

**2. Login.vue（登录页）**
* 功能：用户登录
* 数据：用户名、密码
* 交互：登录成功后跳转首页，存储 user_id 到 localStorage

**3. Register.vue（注册页）**
* 功能：用户注册
* 数据：用户名、密码、昵称
* 交互：注册成功后跳转登录页

**4. Upload.vue（上传页）**
* 功能：视频文件上传、封面图片上传、视频信息填写
* 数据：视频文件、封面文件、标题、描述、分类
* 交互：表单提交、文件预览

**5. VideoDetail.vue（视频详情页）**
* 功能：视频播放、评论列表、点赞收藏
* 数据：视频详情、评论列表、点赞状态、收藏状态
* 交互：播放视频、发表评论、回复评论、点赞、收藏
* **播放器：** 使用 ArtPlayer 播放器，支持画中画、截图、倍速等功能

**6. Profile.vue（个人中心）**
* 功能：资料修改、我的视频、我的收藏
* 数据：用户信息、我的视频列表、我的收藏列表
* 交互：修改资料、查看我的视频、查看我的收藏

**7. AdminAudit.vue（管理员审核页）**
* 功能：待审核列表、审核操作
* 数据：待审核视频列表
* 交互：审核通过、审核驳回、删除视频

**8. AuthorPage.vue（作者主页）**
* 功能：展示指定用户的信息和已发布的视频列表
* 数据：用户信息、用户已发布的视频列表
* 交互：查看作者信息、点击视频卡片跳转详情页
* 入口：从视频详情页点击作者头像进入

---

## 4. 数据库设计

### 4.1 ER 关系图

```
┌─────────┐         ┌─────────┐
│  User   │────────<│  Video  │
└─────────┘ 1    *  └─────────┘
     │                 │ │
     │                 │ │
     │ *          *    │ │ *
     │                 │ │
┌─────────┐       ┌──────────┐   ┌────────────┐
│ Comment │       │   Like   │   │ Collection │
└─────────┘       └──────────┘   └────────────┘
     │ │
     │ │ (自关联)
     │ │
  parent_id
   root_id

┌──────────┐       ┌─────────┐
│Category  │──────<│  Video  │
└──────────┘ 1   * └─────────┘
```

### 4.2 外键关系

| 表名 | 外键字段 | 关联表 | 级联操作 |
|------|----------|--------|----------|
| videos | user_id | users | CASCADE（删除用户时删除视频） |
| videos | category_id | categories | - |
| comments | user_id | users | CASCADE |
| comments | video_id | videos | CASCADE |
| comments | parent_id | comments（自关联） | CASCADE |
| comments | root_id | comments（自关联） | CASCADE |
| likes | user_id | users | CASCADE |
| likes | video_id | videos | CASCADE |
| collections | user_id | users | CASCADE |
| collections | video_id | videos | CASCADE |

### 4.3 唯一约束

* `likes`: (user_id, video_id) - 防止重复点赞
* `collections`: (user_id, video_id) - 防止重复收藏
* `users.username`: UNIQUE - 用户名唯一
* `categories.name`: UNIQUE - 分类名唯一

### 4.4 索引设计

* `users.username`: 索引（用于快速查找用户）
* `videos.status`: 索引（用于筛选已发布视频）
* `videos.created_at`: 索引（用于排序）
* `comments`: 联合索引 `idx_video_root` (video_id, root_id) - 优化评论查询

---

## 5. 接口设计

### 5.1 API 端点总览

```
/api
├── /auth                    # 认证模块
│   ├── POST   /register     # 注册
│   ├── POST   /login        # 登录
│   └── GET    /me           # 获取当前用户
│
├── /videos                  # 视频模块
│   ├── GET    /categories   # 获取分类
│   ├── POST   /upload       # 上传视频
│   ├── GET    /list         # 视频列表
│   └── GET    /<id>         # 视频详情
│
├── /users                   # 用户模块
│   ├── /me
│   │   ├── GET    /me              # 获取用户信息
│   │   ├── PUT    /me              # 更新资料
│   │   ├── GET    /me/videos       # 我的视频
│   │   └── GET    /me/collections  # 我的收藏
│   └── GET    /<user_id>           # 获取指定用户信息（作者主页）
│
├── /admin                   # 管理员模块
│   ├── GET    /manage/list         # 管理列表
│   ├── GET    /audit/list          # 待审核列表
│   ├── POST   /audit/<video_id>    # 审核操作
│   └── DELETE /manage/video/<id>   # 删除视频
│
└── /videos/<video_id>       # 互动模块
    ├── POST   /comments            # 发表评论
    ├── GET    /comments            # 获取评论
    ├── POST   /like                # 点赞/取消
    ├── GET    /like/status         # 点赞状态
    ├── POST   /collect             # 收藏/取消
    └── GET    /collect/status      # 收藏状态
```

### 5.2 统一响应格式

**成功响应：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": { ... }
}
```

**错误响应：**
```json
{
  "code": 400/401/404/500,
  "msg": "错误信息",
  "data": null
}
```

**HTTP 状态码：**
* 200 - 成功
* 201 - 创建成功
* 400 - 请求参数错误
* 401 - 未授权
* 404 - 资源不存在
* 409 - 资源冲突（如用户名已存在）
* 500 - 服务器错误

### 5.3 关键接口设计

#### 5.3.1 用户注册接口

**请求：**
```
POST /api/auth/register
Content-Type: application/json

{
  "username": "2318140407",
  "password": "123456",
  "nickname": "张三"
}
```

**响应：**
```json
{
  "code": 200,
  "msg": "注册成功",
  "data": {
    "id": 1,
    "username": "2318140407",
    "nickname": "张三"
  }
}
```

#### 5.3.2 视频上传接口

**请求：**
```
POST /api/videos/upload
Content-Type: multipart/form-data

user_id: 1
title: 测试视频
description: 这是一个测试视频
category_id: 1
video_file: [文件]
cover_file: [文件]
```

**响应：**
```json
{
  "code": 200,
  "msg": "视频上传成功，等待管理员审核",
  "data": {
    "id": 1,
    "title": "测试视频",
    "status": 0,
    "is_admin": false
  }
}
```

#### 5.3.3 视频列表接口

**请求：**
```
GET /api/videos/list?keyword=测试&category_id=1
```

**响应：**
```json
{
  "code": 200,
  "msg": "获取视频列表成功",
  "data": [
    {
      "id": 1,
      "title": "测试视频",
      "cover_url": "http://localhost:5001/static/covers/xxx.jpg",
      "video_url": "http://localhost:5001/static/videos/xxx.mp4",
      "view_count": 100,
      "likes_count": 10,
      "collections_count": 5,
      "author": {
        "id": 1,
        "nickname": "张三",
        "avatar": "/static/avatars/xxx.jpg"
      },
      "category": {
        "id": 1,
        "name": "校园生活"
      }
    }
  ]
}
```

#### 5.3.4 获取指定用户信息接口（作者主页）

**请求：**
```
GET /api/users/1
```

**响应：**
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "user": {
      "id": 1,
      "username": "2318140407",
      "nickname": "张三",
      "avatar": "avatars/xxx.jpg",
      "role": "user",
      "created_at": "2026-01-01T00:00:00"
    },
    "videos": {
      "total": 5,
      "list": [
        {
          "id": 1,
          "title": "测试视频",
          "cover_url": "http://localhost:5001/static/covers/xxx.jpg",
          "video_url": "http://localhost:5001/static/videos/xxx.mp4",
          "view_count": 100,
          "likes_count": 10,
          "collections_count": 5,
          "status": 1,
          "created_at": "2026-01-01T00:00:00",
          "category": {
            "id": 1,
            "name": "校园生活"
          }
        }
      ]
    }
  }
}
```

**说明：**
* 此接口用于作者主页，仅返回该用户已发布（status=1）的视频
* 从视频详情页点击作者头像可跳转到作者主页

---

## 6. 算法设计

### 6.1 视频审核状态流转算法

```
上传 → status=0 (待审核) → 审核通过 → status=1 (已发布)
                     ↓ 审核驳回
                status=2 (已驳回)
```

**实现逻辑：**
1. 普通用户上传：创建 Video 记录，status=0
2. 管理员上传：创建 Video 记录，status=1
3. 管理员审核：更新 Video.status 为 1（通过）或 2（驳回）

### 6.2 多级评论树构建算法

**数据结构：**
* 一级评论：parent_id=None, root_id=None
* 回复评论：
  * 如果父评论是一级评论：root_id = parent_id
  * 如果父评论是回复：root_id = 父评论的 root_id

**前端构建树算法：**
```javascript
// 分离一级评论和回复
const rootComments = []
const repliesMap = {}

comments.forEach(comment => {
  if (comment.root_id === null) {
    // 一级评论
    rootComments.push({ ...comment, replies: [] })
  } else {
    // 回复评论，按 root_id 分组
    if (!repliesMap[comment.root_id]) {
      repliesMap[comment.root_id] = []
    }
    repliesMap[comment.root_id].push(comment)
  }
})

// 将回复挂载到对应的一级评论下
rootComments.forEach(root => {
  root.replies = repliesMap[root.id] || []
})
```

### 6.3 文件命名算法

**算法：** 时间戳 + UUID

**实现：**
```python
timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
unique_id = str(uuid.uuid4())[:8]
filename = f"{timestamp}_{unique_id}{ext}"
```

**示例：** `20260104003424_8a771008.mp4`

### 6.4 密码加密算法

**算法：** Werkzeug 的 pbkdf2:sha256

**实现：**
```python
from werkzeug.security import generate_password_hash, check_password_hash

# 加密
password_hash = generate_password_hash(password)

# 验证
is_valid = check_password_hash(password_hash, password)
```

---

## 7. 安全设计

### 7.1 密码安全

* **加密方式：** 使用 Werkzeug 的 `generate_password_hash()` 进行加盐哈希
* **算法：** pbkdf2:sha256
* **存储：** 数据库中存储哈希值，不存储明文密码

### 7.2 文件上传安全

* **文件类型验证：** 严格验证文件扩展名
* **文件大小限制：** 最大 500MB
* **文件名处理：** 使用时间戳+UUID，避免文件名冲突和路径遍历攻击

### 7.3 SQL 注入防护

* **使用 ORM：** 使用 SQLAlchemy ORM，避免直接拼接 SQL
* **参数化查询：** 所有数据库操作使用参数化查询

### 7.4 权限控制

* **角色区分：** 用户分为普通用户（user）和管理员（admin）
* **审核机制：** 普通用户上传的视频需要审核，管理员上传直接发布
* **接口权限：** 管理员接口需要验证管理员身份

### 7.5 XSS 防护

* **前端转义：** 前端对用户输入进行转义处理
* **内容过滤：** 评论内容进行敏感词过滤（可扩展）

---

## 8. 性能优化设计

### 8.1 数据库优化

* **索引设计：** 在常用查询字段上建立索引（username、status、created_at）
* **联合索引：** 评论表建立联合索引 `idx_video_root` 优化查询
* **延迟加载：** 使用 `lazy='dynamic'` 延迟加载关系数据

### 8.2 查询优化

* **分页查询：** 视频列表支持分页（可扩展）
* **条件过滤：** 在数据库层面进行过滤，减少数据传输
* **只查询必要字段：** 避免查询不必要的数据

### 8.3 前端优化

* **组件懒加载：** 路由组件使用懒加载
* **图片懒加载：** 视频封面使用懒加载（可扩展）
* **请求防抖：** 搜索功能使用防抖（可扩展）

---

## 9. 运行环境规定

### 9.1 设备

* **服务器端：**
  * **处理器：** Intel Core i5 或同级以上 CPU
  * **内存：** 建议 8GB 或以上
  * **外存：** 建议 512GB SSD，用于存储视频文件

* **客户端：**
  * 任何安装有现代浏览器的 PC 或笔记本电脑（推荐 Chrome 80+, Edge, Firefox）

### 9.2 支持软件

* **操作系统：** Windows 10/11, macOS, 或 Linux (Ubuntu/CentOS)
* **数据库系统：** MySQL 8.0 Community Edition
* **开发语言环境：** Python 3.8+, Node.js 16+（开发阶段）
* **Web 服务器：** Nginx（生产环境）或 Flask Built-in Server（测试环境）

### 9.3 接口

* **通信协议：** HTTP/1.1（未来可升级 HTTPS）
* **数据交换：** 前后端完全分离，通过 JSON 格式交换数据

### 9.4 控制

* **会话控制：** 系统通过请求头 `X-User-ID` 传递用户ID（简化版，可升级为 JWT Token）
* **并发控制：** 数据库采用 InnoDB 引擎，利用行级锁处理高并发下的点赞与评论写入

---

## 10. 扩展设计

### 10.1 认证升级

* **JWT Token：** 引入 JWT Token 认证，替代当前的简化认证
* **Token 刷新：** 实现 Token 刷新机制
* **权限中间件：** 实现权限中间件，统一处理权限验证

### 10.2 文件存储升级

* **对象存储：** 迁移到对象存储服务（OSS/S3）
* **CDN 加速：** 支持 CDN 加速
* **视频转码：** 实现视频转码（多分辨率）

### 10.3 功能增强

* **视频搜索优化：** 实现全文检索
* **用户关注功能：** 添加用户关注功能
* **私信功能：** 实现用户私信功能
* **视频推荐算法：** 基于用户行为的推荐算法

---

**文档版本：** v1.0  
**最后更新：** 2025-01-04  
**维护者：** 开发团队
