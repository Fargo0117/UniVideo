# 用户工作流

<cite>
**本文引用的文件**
- [frontend/src/router/index.js](file://frontend/src/router/index.js)
- [frontend/src/views/Home.vue](file://frontend/src/views/Home.vue)
- [frontend/src/views/Login.vue](file://frontend/src/views/Login.vue)
- [frontend/src/views/Register.vue](file://frontend/src/views/Register.vue)
- [frontend/src/views/Upload.vue](file://frontend/src/views/Upload.vue)
- [frontend/src/views/VideoDetail.vue](file://frontend/src/views/VideoDetail.vue)
- [frontend/src/views/AdminAudit.vue](file://frontend/src/views/AdminAudit.vue)
- [frontend/src/api.js](file://frontend/src/api.js)
- [backend/app.py](file://backend/app.py)
- [backend/routes/auth.py](file://backend/routes/auth.py)
- [backend/routes/video.py](file://backend/routes/video.py)
- [backend/routes/interaction.py](file://backend/routes/interaction.py)
- [backend/routes/admin.py](file://backend/routes/admin.py)
- [backend/models.py](file://backend/models.py)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 引言
本文件系统梳理 UniVideo 平台的关键用户操作流程，覆盖普通用户与管理员两类角色的典型使用路径，并结合前端 Vue 组件的跳转逻辑与状态变化，图示化展示各步骤间的页面流转与数据传递。同时，针对上传失败、审核拒绝等边界情况进行说明，并给出系统反馈机制，帮助开发者理解用户体验设计背后的逻辑。

## 项目结构
- 前端采用 Vue 3 + Vite，通过路由驱动页面跳转，组件负责渲染与交互。
- 后端采用 Flask，提供 REST API，蓝图划分认证、视频、互动、管理员等模块。
- 前端通过 Axios 实例统一发起请求，后端通过 X-User-ID 请求头透传用户身份。

```mermaid
graph TB
subgraph "前端"
R["路由<br/>router/index.js"]
H["首页<br/>Home.vue"]
L["登录<br/>Login.vue"]
Reg["注册<br/>Register.vue"]
U["上传<br/>Upload.vue"]
D["详情<br/>VideoDetail.vue"]
A["审核后台<br/>AdminAudit.vue"]
API["HTTP客户端<br/>api.js"]
end
subgraph "后端"
APP["应用入口<br/>app.py"]
AUTH["认证模块<br/>routes/auth.py"]
VIDEO["视频模块<br/>routes/video.py"]
INTER["互动模块<br/>routes/interaction.py"]
ADMIN["管理模块<br/>routes/admin.py"]
MODELS["模型定义<br/>models.py"]
end
R --> H
R --> L
R --> Reg
R --> U
R --> D
R --> A
H --> API
L --> API
Reg --> API
U --> API
D --> API
A --> API
API --> APP
APP --> AUTH
APP --> VIDEO
APP --> INTER
APP --> ADMIN
ADMIN --> MODELS
VIDEO --> MODELS
AUTH --> MODELS
INTER --> MODELS
```

图表来源
- [frontend/src/router/index.js](file://frontend/src/router/index.js#L1-L56)
- [frontend/src/views/Home.vue](file://frontend/src/views/Home.vue#L1-L131)
- [frontend/src/views/Login.vue](file://frontend/src/views/Login.vue#L1-L53)
- [frontend/src/views/Register.vue](file://frontend/src/views/Register.vue#L1-L55)
- [frontend/src/views/Upload.vue](file://frontend/src/views/Upload.vue#L1-L225)
- [frontend/src/views/VideoDetail.vue](file://frontend/src/views/VideoDetail.vue#L1-L328)
- [frontend/src/views/AdminAudit.vue](file://frontend/src/views/AdminAudit.vue#L1-L205)
- [frontend/src/api.js](file://frontend/src/api.js#L1-L41)
- [backend/app.py](file://backend/app.py#L1-L60)
- [backend/routes/auth.py](file://backend/routes/auth.py#L1-L184)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L282)
- [backend/routes/interaction.py](file://backend/routes/interaction.py#L1-L408)
- [backend/routes/admin.py](file://backend/routes/admin.py#L1-L245)
- [backend/models.py](file://backend/models.py#L1-L343)

章节来源
- [frontend/src/router/index.js](file://frontend/src/router/index.js#L1-L56)
- [backend/app.py](file://backend/app.py#L1-L60)

## 核心组件
- 路由与页面跳转：前端路由定义了首页、登录、注册、上传、视频详情、管理员后台等页面，组件内部通过 router.push 实现页面跳转。
- 用户认证：登录/注册组件调用后端认证接口，成功后将用户信息写入 localStorage，并跳转首页。
- 视频上传：上传组件负责表单校验、文件选择与预览、封面截取、FormData 提交，后端根据用户角色决定状态（待审核/已发布）。
- 视频浏览与互动：首页组件负责分类与搜索筛选，详情页负责播放、点赞、收藏、评论树形展示。
- 管理后台：管理员后台负责视频列表、搜索筛选、审核（通过/驳回）、删除等操作。

章节来源
- [frontend/src/views/Home.vue](file://frontend/src/views/Home.vue#L1-L131)
- [frontend/src/views/Login.vue](file://frontend/src/views/Login.vue#L1-L53)
- [frontend/src/views/Register.vue](file://frontend/src/views/Register.vue#L1-L55)
- [frontend/src/views/Upload.vue](file://frontend/src/views/Upload.vue#L1-L225)
- [frontend/src/views/VideoDetail.vue](file://frontend/src/views/VideoDetail.vue#L1-L328)
- [frontend/src/views/AdminAudit.vue](file://frontend/src/views/AdminAudit.vue#L1-L205)

## 架构总览
前后端通过 REST API 通信，前端通过拦截器在请求头注入 X-User-ID，后端据此识别当前用户身份，实现“简化版”鉴权。

```mermaid
sequenceDiagram
participant F as "前端组件"
participant R as "路由"
participant API as "Axios拦截器"
participant S as "Flask后端"
participant B as "蓝图模块"
participant M as "模型层"
F->>R : 路由跳转
R-->>F : 渲染目标组件
F->>API : 发起HTTP请求
API->>S : 添加X-User-ID请求头
S->>B : 路由分发
B->>M : 数据库读写
M-->>B : 结果数据
B-->>S : JSON响应
S-->>API : 响应
API-->>F : 响应数据
```

图表来源
- [frontend/src/api.js](file://frontend/src/api.js#L1-L41)
- [backend/app.py](file://backend/app.py#L1-L60)
- [backend/routes/auth.py](file://backend/routes/auth.py#L1-L184)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L282)
- [backend/routes/interaction.py](file://backend/routes/interaction.py#L1-L408)
- [backend/routes/admin.py](file://backend/routes/admin.py#L1-L245)
- [backend/models.py](file://backend/models.py#L1-L343)

## 详细组件分析

### 普通用户工作流（注册→登录→上传→浏览→播放→互动）
- 注册与登录
  - 注册：前端校验必填与密码长度，调用后端注册接口，成功后提示并跳转登录页。
  - 登录：前端校验表单，调用后端登录接口，成功后将用户信息存入 localStorage 并跳转首页。
- 浏览与搜索
  - 首页加载分类与视频列表，支持关键词与分类筛选，点击视频卡片跳转详情页。
- 上传视频
  - 上传页加载分类，选择视频与封面（支持手动选择或截取当前帧），提交时进行表单校验与用户身份校验，后端根据角色设置状态（普通用户上传默认待审核，管理员直接发布）。
- 播放与互动
  - 详情页加载视频信息、播放量+1、点赞/收藏状态与评论列表；支持发表评论与回复评论；未登录用户在互动时会被引导登录。

```mermaid
sequenceDiagram
participant U as "普通用户"
participant Reg as "注册组件<br/>Register.vue"
participant Log as "登录组件<br/>Login.vue"
participant Home as "首页组件<br/>Home.vue"
participant Up as "上传组件<br/>Upload.vue"
participant Detail as "详情组件<br/>VideoDetail.vue"
participant API as "Axios拦截器<br/>api.js"
participant Auth as "认证接口<br/>routes/auth.py"
participant Vid as "视频接口<br/>routes/video.py"
participant Inter as "互动接口<br/>routes/interaction.py"
U->>Reg : 填写注册信息并提交
Reg->>API : POST /api/auth/register
API->>Auth : 转发请求
Auth-->>API : 注册结果
API-->>Reg : 成功/失败消息
Reg-->>U : 跳转登录页
U->>Log : 输入用户名/密码并登录
Log->>API : POST /api/auth/login
API->>Auth : 转发请求
Auth-->>API : 用户信息
API-->>Log : 成功/失败消息
Log-->>U : 跳转首页
U->>Up : 选择视频与封面并提交
Up->>API : POST /api/videos/upload
API->>Vid : 转发请求
Vid-->>API : 上传结果状态：待审核/已发布
API-->>Up : 成功/失败消息
Up-->>U : 跳转首页
U->>Home : 搜索/筛选并点击视频
Home->>API : GET /api/videos/list
API->>Vid : 转发请求
Vid-->>API : 视频列表
API-->>Home : 列表数据
Home-->>U : 渲染视频卡片
U->>Detail : 点击视频卡片进入详情
Detail->>API : GET /api/videos/ : id
API->>Vid : 转发请求
Vid-->>API : 视频详情播放量+1
API-->>Detail : 详情数据
Detail->>API : GET /api/videos/ : id/like/status
Detail->>API : GET /api/videos/ : id/collect/status
Detail->>API : GET /api/videos/ : id/comments
Detail->>API : POST /api/videos/ : id/like
Detail->>API : POST /api/videos/ : id/collect
Detail->>API : POST /api/videos/ : id/comments
API->>Inter : 转发互动请求
Inter-->>API : 互动结果
API-->>Detail : 互动结果
Detail-->>U : 更新UI与提示
```

图表来源
- [frontend/src/views/Register.vue](file://frontend/src/views/Register.vue#L1-L55)
- [frontend/src/views/Login.vue](file://frontend/src/views/Login.vue#L1-L53)
- [frontend/src/views/Home.vue](file://frontend/src/views/Home.vue#L1-L131)
- [frontend/src/views/Upload.vue](file://frontend/src/views/Upload.vue#L1-L225)
- [frontend/src/views/VideoDetail.vue](file://frontend/src/views/VideoDetail.vue#L1-L328)
- [frontend/src/api.js](file://frontend/src/api.js#L1-L41)
- [backend/routes/auth.py](file://backend/routes/auth.py#L1-L184)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L282)
- [backend/routes/interaction.py](file://backend/routes/interaction.py#L1-L408)

章节来源
- [frontend/src/views/Register.vue](file://frontend/src/views/Register.vue#L1-L55)
- [frontend/src/views/Login.vue](file://frontend/src/views/Login.vue#L1-L53)
- [frontend/src/views/Home.vue](file://frontend/src/views/Home.vue#L1-L131)
- [frontend/src/views/Upload.vue](file://frontend/src/views/Upload.vue#L1-L225)
- [frontend/src/views/VideoDetail.vue](file://frontend/src/views/VideoDetail.vue#L1-L328)
- [frontend/src/api.js](file://frontend/src/api.js#L1-L41)
- [backend/routes/auth.py](file://backend/routes/auth.py#L1-L184)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L282)
- [backend/routes/interaction.py](file://backend/routes/interaction.py#L1-L408)

### 管理员后台工作流（登录→审核→管理已发布视频）
- 登录与权限校验
  - 管理员登录后进入后台，组件在 mounted 中校验角色，非管理员将被提示并返回首页。
- 视频管理
  - 列表加载：支持关键词搜索与状态筛选（待审核/已发布/已驳回）。
  - 审核：对“待审核”视频执行“通过/驳回”，后端更新状态并返回结果。
  - 删除：支持删除视频，后端尝试删除物理文件并清理数据库记录。

```mermaid
sequenceDiagram
participant Admin as "管理员"
participant APage as "审核组件<br/>AdminAudit.vue"
participant API as "Axios拦截器<br/>api.js"
participant AdminAPI as "管理接口<br/>routes/admin.py"
participant VidAPI as "视频接口<br/>routes/video.py"
Admin->>APage : 登录后进入后台
APage->>API : GET /api/admin/manage/list
API->>AdminAPI : 转发请求
AdminAPI-->>API : 视频列表
API-->>APage : 列表数据
Admin->>APage : 选择状态并搜索
APage->>API : GET /api/admin/manage/list?keyword&status
API->>AdminAPI : 转发请求
AdminAPI-->>API : 列表数据
API-->>APage : 列表数据
Admin->>APage : 点击“通过/驳回”
APage->>API : POST /api/admin/audit/ : id {action}
API->>AdminAPI : 转发请求
AdminAPI-->>API : 审核结果
API-->>APage : 结果消息
APage->>API : GET /api/admin/manage/list
API->>AdminAPI : 刷新列表
Admin->>APage : 点击“删除”
APage->>API : DELETE /api/admin/manage/video/ : id
API->>AdminAPI : 转发请求
AdminAPI-->>API : 删除结果
API-->>APage : 结果消息
APage->>API : GET /api/admin/manage/list
API->>AdminAPI : 刷新列表
```

图表来源
- [frontend/src/views/AdminAudit.vue](file://frontend/src/views/AdminAudit.vue#L1-L205)
- [frontend/src/api.js](file://frontend/src/api.js#L1-L41)
- [backend/routes/admin.py](file://backend/routes/admin.py#L1-L245)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L282)

章节来源
- [frontend/src/views/AdminAudit.vue](file://frontend/src/views/AdminAudit.vue#L1-L205)
- [frontend/src/api.js](file://frontend/src/api.js#L1-L41)
- [backend/routes/admin.py](file://backend/routes/admin.py#L1-L245)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L282)

### 上传流程细节与边界情况
- 表单校验与文件处理
  - 标题、分类、视频文件、封面文件必填校验；封面可手动选择或从视频截取当前帧。
  - 上传前检查用户登录状态，未登录则跳转登录页。
- 后端状态决策
  - 普通用户上传：默认状态为“待审核”，提示“等待管理员审核”。
  - 管理员上传：默认状态为“已发布”，提示“视频上传成功，已直接发布”。

```mermaid
flowchart TD
Start(["开始上传"]) --> CheckForm["校验表单<br/>标题/分类/视频/封面"]
CheckForm --> FormOK{"表单通过？"}
FormOK -- 否 --> ShowErr1["提示错误并阻止提交"]
FormOK -- 是 --> CheckUser["检查用户登录状态"]
CheckUser --> UserOK{"已登录？"}
UserOK -- 否 --> GoLogin["跳转登录页"]
UserOK -- 是 --> BuildFD["构建FormData<br/>user_id/title/description/category_id/video_file/cover_file"]
BuildFD --> PostAPI["POST /api/videos/upload"]
PostAPI --> Role{"用户角色？"}
Role -- 普通用户 --> Pending["状态=待审核"]
Role -- 管理员 --> Published["状态=已发布"]
Pending --> Done(["完成"])
Published --> Done
ShowErr1 --> End(["结束"])
GoLogin --> End
```

图表来源
- [frontend/src/views/Upload.vue](file://frontend/src/views/Upload.vue#L1-L225)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L171)

章节来源
- [frontend/src/views/Upload.vue](file://frontend/src/views/Upload.vue#L1-L225)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L171)

### 审核拒绝与系统反馈
- 审核拒绝
  - 管理员在后台对“待审核”视频执行“驳回”，后端将状态更新为“已驳回”，并返回结果。
  - 驳回后，普通用户在首页无法看到该视频（后端仅返回已发布状态的视频列表）。
- 系统反馈
  - 前端通过 alert 显示后端返回的消息；列表刷新后自动反映最新状态。
  - 详情页对未登录用户进行拦截，引导登录后再进行互动。

章节来源
- [frontend/src/views/AdminAudit.vue](file://frontend/src/views/AdminAudit.vue#L1-L205)
- [backend/routes/admin.py](file://backend/routes/admin.py#L1-L173)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L226)
- [frontend/src/views/VideoDetail.vue](file://frontend/src/views/VideoDetail.vue#L1-L328)

## 依赖分析
- 前端依赖
  - 路由依赖：router/index.js 定义页面映射，组件内通过 router.push 跳转。
  - API 依赖：api.js 统一配置 baseURL、超时与请求头注入 X-User-ID。
  - 组件依赖：各页面组件依赖后端接口返回的数据结构，如视频列表、评论树、点赞/收藏状态等。
- 后端依赖
  - 应用入口：app.py 注册蓝图，初始化 CORS、数据库与上传目录。
  - 蓝图依赖：auth、video、interaction、admin 模块各自处理业务逻辑与模型交互。
  - 模型依赖：models.py 定义 User、Category、Video、Comment、Like、Collection 等实体及其关系。

```mermaid
graph TB
API["api.js"] --> APP["app.py"]
APP --> AUTH["routes/auth.py"]
APP --> VIDEO["routes/video.py"]
APP --> INTER["routes/interaction.py"]
APP --> ADMIN["routes/admin.py"]
ADMIN --> MODELS["models.py"]
VIDEO --> MODELS
AUTH --> MODELS
INTER --> MODELS
```

图表来源
- [frontend/src/api.js](file://frontend/src/api.js#L1-L41)
- [backend/app.py](file://backend/app.py#L1-L60)
- [backend/routes/auth.py](file://backend/routes/auth.py#L1-L184)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L282)
- [backend/routes/interaction.py](file://backend/routes/interaction.py#L1-L408)
- [backend/routes/admin.py](file://backend/routes/admin.py#L1-L245)
- [backend/models.py](file://backend/models.py#L1-L343)

章节来源
- [frontend/src/api.js](file://frontend/src/api.js#L1-L41)
- [backend/app.py](file://backend/app.py#L1-L60)
- [backend/models.py](file://backend/models.py#L1-L343)

## 性能考虑
- 前端
  - 首页视频列表与分类加载采用懒加载与空状态提示，减少首屏压力。
  - 上传页在预览与截取封面时注意释放 Object URL，避免内存泄漏。
  - 详情页对评论树进行一次性计算，避免重复渲染。
- 后端
  - 视频列表仅查询已发布状态并按时间倒序，降低查询复杂度。
  - 上传接口对文件类型进行白名单校验，避免非法扩展名导致的存储与解析问题。
  - 审核接口对重复审核进行保护，避免状态异常。

[本节为通用建议，无需列出具体文件来源]

## 故障排查指南
- 登录失败
  - 检查用户名/密码是否为空，确认后端返回的错误消息。
  - 确认前端已将用户信息写入 localStorage 并跳转首页。
- 上传失败
  - 检查必填字段与文件类型是否符合后端要求。
  - 确认用户已登录，且后端根据角色返回了正确的状态提示。
- 审核异常
  - 若视频状态非“待审核”，再次审核将被拒绝，需检查当前状态。
  - 删除视频时若物理文件删除失败，数据库仍会删除记录，需检查文件系统权限。
- 详情页互动
  - 未登录用户进行点赞/收藏/评论会被提示登录。
  - 评论树加载失败时，前端会清空列表并输出错误提示。

章节来源
- [frontend/src/views/Login.vue](file://frontend/src/views/Login.vue#L1-L53)
- [frontend/src/views/Register.vue](file://frontend/src/views/Register.vue#L1-L55)
- [frontend/src/views/Upload.vue](file://frontend/src/views/Upload.vue#L1-L225)
- [frontend/src/views/AdminAudit.vue](file://frontend/src/views/AdminAudit.vue#L1-L205)
- [frontend/src/views/VideoDetail.vue](file://frontend/src/views/VideoDetail.vue#L1-L328)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L171)
- [backend/routes/admin.py](file://backend/routes/admin.py#L1-L173)

## 结论
UniVideo 的用户工作流围绕“先审后发”的策略展开：普通用户通过注册/登录完成身份建立，上传视频后进入“待审核”状态；管理员在后台进行审核与管理；最终普通用户可在首页浏览已发布的视频并进行互动。前后端通过统一的 API 与请求头实现简化的身份透传，组件间通过路由与状态管理完成流畅的页面流转与数据传递。针对上传失败、审核拒绝等边界情况，系统通过明确的错误提示与状态反馈保障用户体验。

[本节为总结性内容，无需列出具体文件来源]

## 附录
- 关键接口与职责
  - 认证：注册、登录、获取当前用户信息。
  - 视频：获取分类、上传视频、获取视频列表、获取视频详情。
  - 互动：发表评论、点赞/取消点赞、收藏/取消收藏、获取评论列表与状态。
  - 管理：获取视频管理列表、获取待审核列表、审核视频、删除视频。

章节来源
- [backend/routes/auth.py](file://backend/routes/auth.py#L1-L184)
- [backend/routes/video.py](file://backend/routes/video.py#L1-L282)
- [backend/routes/interaction.py](file://backend/routes/interaction.py#L1-L408)
- [backend/routes/admin.py](file://backend/routes/admin.py#L1-L245)